<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>rndmfg ‚Äî Blockly (Python generator)</title>

  <!-- Icons (unchanged) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/brands.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <script>
    (function loadBlockly() {
      function add(src, next) {
        var s = document.createElement('script');
        s.src = src;
        s.defer = false;
        s.async = false;
        s.onload = next || null;
        s.onerror = function () { console.error("Failed to load:", src); };
        document.head.appendChild(s);
      }

      // 1. Core
      add('https://unpkg.com/blockly@10.4.3/blockly_compressed.js', function () {
        // 2. Blocks
        add('https://unpkg.com/blockly@10.4.3/blocks_compressed.js', function () {
          // 3. Python
          add('https://unpkg.com/blockly@10.4.3/python_compressed.js', function () {
            // 4. English Language (MOVED INSIDE)
            add('https://cdn.jsdelivr.net/npm/blockly@10.4.3/msg/en.js', function () {
              console.log("Blockly loaded successfully!");
              window.__blocklyLoaded = true;
            });
          });
        });
      });
    })();
  </script>
  <style>
    :root {
      --mint: #cfeff2;
      --panel: #f7fbfc;
      --grid: #cfe7ec;
      --shadow: 0 10px 24px rgba(23, 46, 56, .12)
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: var(--mint);
      font: 500 16px/1.4 Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif
    }

    .app {
      display: grid;
      grid-template-rows: 72px 1fr;
      grid-template-columns: 220px 1fr;
      gap: 14px;
      padding: 14px
    }

    .brand img {
      width: 60px;
      height: auto;
      object-fit: contain;
    }

    .topbar {
      grid-column: 1/-1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--panel);
      border-radius: 999px;
      padding: 10px 16px;
      box-shadow: var(--shadow)
    }

    .btns {
      display: flex;
      gap: 10px
    }

    .btn-circle {
      width: 42px;
      height: 42px;
      border: 0;
      border-radius: 50%;
      box-shadow: var(--shadow);
      display: grid;
      place-items: center;
      font-size: 18px;
      cursor: pointer
    }

    .play {
      background: #8ee38f
    }

    .unlink {
      background-color: #a3ffaf;
    }

    .save {
      background: #f7a9bf
    }

    .fwd {
      background: #ffd46b
    }

    .cwl {
      background: #FCB6AE;
    }

    .back {
      background: #bcd4ff
    }

    .output {
      background-color: #d0d0d0;
    }

    .rail {
      background: var(--panel);
      border-radius: 28px;
      box-shadow: var(--shadow);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center
    }

    .pill {
      width: 100%;
      padding: 14px 8px;
      border-radius: 16px;
      color: #2b3c47;
      font-weight: 800;
      text-align: center;
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .05), var(--shadow)
    }

    .main {
      display: grid;
      grid-template-columns: 70% 30%;
      overflow: hidden;
      gap: 14px;
      padding: 0 20px;
      height: 100dvh;
    }

    .workspace {
      position: relative;
      min-height: 300px;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: var(--shadow);
      background: #e8f4f7;
      width: 100%;
    }

    .workspace:after {
      content: "";
      position: absolute;
      inset: 0;
      background-image: linear-gradient(to right, var(--grid) 1px, transparent 1px),
        linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
      pointer-events: none;
      width: 100%;
    }

    #blocklyDiv {
      position: absolute;
      inset: 0;
    }

    .code {
      background: var(--panel);
      border-radius: 18px;
      padding: 14px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0
    }

    .code pre {
      margin: 0;
      padding: 14px;
      border-radius: 12px;
      background: #0d1117;
      color: #c9d1d9;
      overflow: auto;
      min-height: 140px;
      flex: 1;
      font: 500 13px/1.6 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace
    }

    .wifi-return {
      padding: 10px;
      background: #dad7d7;
      border-radius: 8px;
    }

    /* ----------------pop up css--------------------- */

    /* Simple modal */
    .box {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 5px 10px;
      gap: 5px;
    }

    .box1 {
      display: flex;
      align-items: center;
    }

    .row {
      text-align: center;
    }

    .box2 {
      display: flex;
    }

    .box button {
      padding: 10px 15px;
      background-color: #DDDDDD;
      border: none;
      border-radius: 10px;
      box-shadow: 5px 2px 5px rgba(0, 0, 0, 0.5);
      cursor: pointer;
      color: black;
      font-size: 16px;
      transition: all 500ms ease;
    }

    .box button:hover {
      background: linear-gradient(to right, #bdbebe, #f5fafc);
    }

    #portSelectionModal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000
    }

    #portSelectionModal {
      width: 300px;
      margin: 10% auto;
      padding: 20px;
      background: linear-gradient(to right, #DDDDDD, #ffffff);
      border-radius: 10px;
      height: fit-content;
      box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
    }

    #portSelectionModal h3 {
      margin: 0 0 10px 0
    }

    #portSelectionModal .row {
      margin: 6px 0
    }

    #motorSelectionModal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000
    }

    #motorSelectionModal {
      width: 300px;
      margin: 10% auto;
      padding: 20px;
      background: linear-gradient(to right, #ffdede, #13f7ff);
      border-radius: 10px;
      height: fit-content;
      box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
    }

    #motorSelectionModal h3 {
      margin: 0 0 10px 0
    }

    #motorSelectionModal .row {
      margin: 6px 0
    }

    #ledPinSelectionModal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000
    }

    /* LED pin modal overlay, same behavior as other modals */
    #ledPinSelectionModal {
      width: 300px;
      margin: auto;
      padding: 20px;

      /* Glass effect */
      background: linear-gradient(rgba(196, 196, 196, 0.65), rgba(255, 255, 255, 0.65));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);

      /* Shape */
      border-radius: 12px;
      height: fit-content;

      /* Depth */
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.35);
      border: 5px solid rgba(196, 196, 196, 0.5);

      /* Smooth look */
      transition: all 0.25s ease;
    }



    /* Servo modal styling */
    #servoSelectionModal {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 1000;
      background: rgba(0, 0, 0, .35);
    }

    #servoSelectionModal .servo-box {
      width: 320px;
      margin: 10% auto;
      padding: 20px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, .25);
      font-family: system-ui, sans-serif;
    }

    #servoSelectionModal h3 {
      margin-top: 0;
      text-align: center;
    }

    .servo-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }

    .servo-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 8px;
      background: #f4f7fb;
      cursor: pointer;
    }

    .servo-row input[type="radio"] {
      margin: 0;
    }

    .servo-name {
      min-width: 80px;
      font-weight: 600;
    }

    .servo-pins {
      display: flex;
      gap: 4px;
    }

    .pin {
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      color: #fff;
    }

    .pin-gnd {
      background: #555;
    }

    .pin-vcc {
      background: #e74c3c;
    }

    .pin-sig {
      background: #3498db;
    }

    .servo-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 16px;
    }

    .servo-actions button {
      padding: 6px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #ddd;
      transition: background .2s;
    }

    .servo-actions button:hover {
      background: #ccc;
    }

    .blocklyText {
      font-size: 16px !important;
    }

    .blocklyHtmlInput,
    .blocklyDropdownText {
      font-size: 16px !important;
    }


    /* Blockly main SVG area */
    .blocklySvg {
      background: #e8f4f7 !important;
    }

    /* .blocklyMainBackground {
      fill: #ffffff !important;
    } */

    .blocklyToolboxDiv {
      background: rgba(15, 23, 42, 0.9) !important;
      border-radius: 16px;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
    }

    .blocklyTreeLabel {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      fill: #e5e7eb !important;
    }

    .blocklyTreeRow.blocklyTreeSelected {
      background: linear-gradient(135deg,
          rgba(56, 189, 248, 1),
          rgb(0, 98, 255)) !important;
      border-radius: 999px;
    }

    .blocklyFlyoutBackground {
      fill: rgba(15, 23, 42, 1) !important;
    }

    .blocklyFlyoutLabelText {
      fill: #9ca3af !important;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    .blocklyScrollbarHandle {
      fill: rgba(148, 163, 184, 0.9) !important;
    }

    .blocklyScrollbarBackground {
      fill: transparent !important;
    }

    .blocklyText {
      fill: #000000 !important;
    }

    /* Remove the solid blue insertion block (ghost block while dragging)  */
    .blocklyInsertionMarker>.blocklyPath {
      fill: none !important;
      stroke: none !important;
      stroke-width: 2px !important;
    }

    .blocklyInsertionMarker>.blocklyPathLight {
      display: none !important;
    }

    /* ===== LIGHT, ATTRACTIVE GRADIENTS ===== */

    /* gradient for ALL blocks */

    /* overrides for specific block types (different colors) */

    .block-servo>.blocklyPath {
      fill: url(#gradServo) !important;
      stroke-width: 1;
      stroke: #F266C1;


    }

    /* CSS to animate the image on hover */
    /* CSS to animate the image on hover */
    .hover-animate {
      transition: transform 0.2s ease-in-out !important;
      display: inline-block !important;
      /* Ensures the transform works as expected */
    }

    .hover-animate:hover {
      transform: translateY(-5px) !important;
      /* Move image upwards by 5px */
    }



    /* 
    .block-servo>.blocklyPath:hover {
      transition: all 500ms ease-in-out;
      transform: translateY(-5px);
    } */

    .led_style>.blocklyPath {
      fill: url(#gradled) !important;
      stroke-width: 1;
      stroke: #8C041D;
    }

    .dummy_block>.blocklyPath {
      fill: url(#dummy_style);
      stroke-width: 1px;
      stroke: #79A637;
    }

    .block_dc>.blocklyPath {
      fill: url(#graddc);
      stroke-width: 1px;
      stroke: #F2C744;
    }

    .temp_style>.blocklyPath {
      fill: url(#temp_style);
      stroke-width: 1px;
      stroke: #73168C;

    }

    .ultra_style>.blocklyPath {
      fill: url(#ultra_style);
      stroke-width: 1px;
      stroke: #593A28;
    }

    .defult_style>.blocklyPath {
      fill: url(#gradDefault);
      stroke: #2685BF;
      stroke-width: 1px;
    }

    /* WiFi Modal Styling */
    #wifiSettingsModal {
      position: fixed;
      inset: 0;
      z-index: 1100;
      width: 300px;
      margin: 10% auto;
      padding: 20px;
      background: linear-gradient(to right, #eef2f3, #8e9eab);
      /* Matches your theme */
      border-radius: 12px;
      height: fit-content;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.35);
      border: 2px solid rgba(255, 255, 255, 0.5);
      font-family: system-ui, sans-serif;
    }

    #wifiSettingsModal h3 {
      text-align: center;
      color: #333;
      margin-top: 0;
    }



    @media screen and (max-width: 1200px) {
      .app {
        grid-template-columns: 1fr;
      }

      .rail {
        display: none;
      }

      .main {
        grid-template-columns: 70% 30%;
        overflow: hidden;
        font-size: 12px;
      }

    }

    .show {
      display: none;
    }

    .main1 {
      grid-template-columns: 1fr;
      overflow: hidden;
      gap: 14px;
      padding: 0 20px;
      height: 100dvh;
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Top bar -->
    <div class="topbar">
      <div class="brand" style="display:flex;align-items:center;gap:10px">
        <img src="./assets/blockly/logo.png" alt="weblogo" style="width:60px; height:auto; object-fit:contain;">
        <div style="font-size:24px;font-weight:900;text-transform:uppercase">rndmfg</div>
      </div>
      <div class="btns">
        <!-- New: Connect Board button (for USB on desktop) -->
        <button class="btn-circle back" id="btnConnect" title="Connect Board">
          <i class="fa-solid fa-plug"></i>
        </button>
        <button class="btn-circle unlink" id="btnDisconnect" title="Disconnect Board">
          <i class="fas fa-unlink"></i>
        </button>

        <button class="btn-circle cwl" id="btnWifiConfig" title="WiFi Setup">
          <i class="fa-solid fa-gear"></i>
        </button>
        <button class="btn-circle fwd" id="btnWifi" title="WiFi Boot">
          <i class="fa-solid fa-wifi"></i>
        </button>
        <button class="btn-circle back" id="btnBluetooth" title="Bluetooth Boot">
          <i class="fa-brands fa-bluetooth-b"></i>
        </button>

        <button class="btn-circle play" id="btnRun" title="Run ‚ñ∂"><i class="fa-solid fa-copy"></i></button>
        <button class="btn-circle cwl" id="btnboot" title="save board"><i
            class="fa-solid fa-cloud-arrow-up"></i></button>

        <button class="btn-circle save" id="btnSave" title="Save"><i class="fa-solid fa-download"></i></button>
        <button class="btn-circle fwd" id="btnLoad" title="Load"><i class="fa-brands fa-openid"></i></button>

        <button class="btn-circle back" id="btnClear" title="Clear"><i class="fa-solid fa-broom"></i></button>
        <button onclick="toggleCodePanel()" class="btn-circle output" id="showCode"><i
            class="fa-solid fa-code"></i></button>
      </div>
    </div>

    <!-- Left rail -->
    <aside class="rail">
      <div class="pill" style="background:#d9f4fb">Motion</div>
      <div class="pill" style="background:#ffd8d1">Ideas</div>
      <div class="pill" style="background:#fff2b9">Search</div>
      <div class="pill" style="background:#e4dcff">Brain</div>
    </aside>
    <!-- ---------------this is the main block with python generator----------------------- -->
    <!-- Main -->
    <section class="main">
      <div class="workspace">
        <div id="blocklyDiv"></div>
      </div>
      <div id="codePanel" class="code">
        <header style="display:flex;justify-content:space-between;align-items:center">
          <strong>Python (generated)</strong><small id="status">ready</small>
        </header>
        <pre id="pyOut"># drag & drop blocks to generate Python‚Ä¶</pre>
        <div id="responseDisplay">Waiting for response...</div>
        <div class="wifi-return">
          üî• Fire: <span id="fireStatus">--</span><br>
          üìè Distance: <span id="distance">--</span><br>
          üîÑ Servo: <span id="servoAngle">--</span><br>
          üí° LED: <span id="ledStatus">--</span><br>
          ‚öôÔ∏è Motor: <span id="motorStatus">--</span><br>
          üå°Ô∏è Tem:<span id="temStatus">--</span>
        </div>

      </div>
    </section>
  </div>

  <!-- Toolbox -->
  <xml id="toolbox" style="display:none">
    <category name="Digital in" colour="#FFD46B">
      <block type="port_on"></block>
      <block type="port_off"></block>
      <block type="sen_ultrasonic"></block>
      <block type="sen_temp"></block>
    </category>
    <category name="Digitalout" colour="#81d4ed">
      <block type="do_onoff"></block>
      <block type="do_dc_motor"></block>
      <block type="do_servo"></block>
      <block type="do_led"></block>
      <block type="bt_send"></block>
      <block type="steper"></block>
      <block type="waterpump"></block>
      <block type="solinoid"></block>
      <block type="animo"></block>
      <block type="relay"></block>
      <block type="buzzer"></block>

    </category>
    <category name="Delay" colour="#92e08d">
      <block type="ctl_delay"></block>
      <block type="do_led_param"></block>
      <block type="rgb_component"></block>
      <block type="shock_sensor"></block>
      <block type="flex-sensor"></block>
      <block type="buzzer_component"></block>
      <block type="relay"></block>
      <block type="joystick_move"></block>
      <block type="Air_quality_sensor"></block>
      <block type="minifan"></block>
      <block type="flexi_force_sensor"></block>
      <block type="TDS_Water_sensor"></block>
      <block type="LCD_print"></block>
      <block type="din_bo"></block>
      <block type="din_flame"></block>
      <block type="din_temp"></block>
      <block type="water_sensor"></block>
    </category>
    <category name="Loop" colour="#FF6347">
      <block type="lp_while"></block>
      <block type="lp_break"></block>
      <block type="lp_start"></block>
      <block type="lp_repeat_count"></block>
      <block type="lp_label"></block>
      <block type="any_input_block"></block>
    </category>
    <category name="motor" colour="#C0603E">
      <block type="mini_motor"></block>
      <block type="remote_motor"></block>
      <block type="water_motor"></block>
      <block type="tank_motor"></block>
    </category>
    <category name="LEDs" colour="#FFB56A">
      <block type="red_led"></block>
      <block type="yellow_led"></block>
      <block type="green_led"></block>
      <!-- <block type="rgb_display"></block>
      <block type="rgb_led_display"></block> -->
    </category>
    <category name="sensor" colour="#2EB061">
      <block type="sensor"></block>
      <block type="tem_sensor"></block>
      <block type="xray_sensor"></block>
      <block type="rc_sensor"></block>
    </category>
    <category name="Digitalin" colour="#FFB56A">
      <block type="loop_end"></block>
      <block type="din_if_else"></block>
      <block type="din_sound"></block>
      <block type="din_tilt"></block>
      <block type="din_door"></block>
      <block type="din_button"></block>
      <block type="din_motion"></block>
      <block type="din_proximity"></block>
      <block type="din_ir"></block>
      <block type="din_flame"></block>
      <block type="load_cell"></block>
      <block type="ultra_sonic"></block>
    </category>
    <sep></sep>
    <category name="Logic" colour="#4C97FF">
      <block type="logic_operation"></block>
      <block type="logic_boolean"></block>
      <block type="logical_comparison"></block>

      <block type="math_number">
        <field name="NUM">1</field>
      </block>
    </category>
    <category name="Maths" colour="#9ACD32">
      <block type="math_number">
        <field name="NUM">1</field>
      </block>
      <block type="text"></block>
      <block type="text_join"></block>
    </category>
    <category name="Function" custom="PROCEDURE" colour="#FF1493"></category>
    <category name="Variable" custom="VARIABLE" colour="#0000FF"></category>
  </xml>

  <!-- Port selection modal -->
  <div id="portSelectionModal">
    <div class="box">
      <h3>Digital Pins</h3>
      <div class="box1">
        <div class="row"><label><input type="checkbox" id="portD3"> D3</label></div>
        <div class="row"><label><input type="checkbox" id="portD4"> D4</label></div>
        <div class="row"><label><input type="checkbox" id="portD5"> D5</label></div>
        <div class="row"><label><input type="checkbox" id="portD6"> D6</label></div>
        <div class="row"><label><input type="checkbox" id="portE3"> E3</label></div>
        <div class="row"><label><input type="checkbox" id="portG4"> G4</label></div>
        <div class="row"><label><input type="checkbox" id="portG5"> G5</label></div>
        <div class="row"><label><input type="checkbox" id="portG6"> G6</label></div>
      </div>
      <div class="box2">
        <div class="row"><label><input type="checkbox" id="portD7"> D7</label></div>
        <div class="row"><label><input type="checkbox" id="portE0"> E0</label></div>
        <div class="row"><label><input type="checkbox" id="portE1"> E1</label></div>
        <div class="row"><label><input type="checkbox" id="portG3"> G3</label></div>
        <div class="row"><label><input type="checkbox" id="portG0"> G0</label></div>
        <div class="row"><label><input type="checkbox" id="portG1"> G1</label></div>
        <div class="row"><label><input type="checkbox" id="portG2"> G2</label></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button onclick="savePortSelection()">Save</button>
        <button onclick="closePortModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Motor selection modal -->
  <div id="motorSelectionModal" style="display:none;">
    <div class="box">
      <h3>Select Motor(s)</h3>
      <div class="box1">
        <div class="row"><label><input type="checkbox" id="motorE12"> E12</label></div>
        <div class="row"><label><input type="checkbox" id="motorE11"> E11</label></div>
        <div class="row"><label><input type="checkbox" id="motorC8"> C8</label></div>
        <div class="row"><label><input type="checkbox" id="motorC9"> C9</label></div>
        <div class="row"><label><input type="checkbox" id="motorB15"> B15</label></div>
        <div class="row"><label><input type="checkbox" id="motorE13"> E13</label></div>
        <div class="row"><label><input type="checkbox" id="motorE14"> E14</label></div>
        <div class="row"><label><input type="checkbox" id="motorD15"> D15</label></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button onclick="saveMotorSelection()">Save</button>
        <button onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Servo selection modal -->
  <div id="servoSelectionModal" style="display:none;">
    <div class="servo-box">
      <h3>Select Servo Port</h3>

      <div class="servo-list">
        <label class="servo-row">
          <input type="radio" name="servoPort" value="C8">
          <div class="servo-name">Servo C8</div>
          <div class="servo-pins">
            <span class="pin pin-gnd">GND</span>
            <span class="pin pin-vcc">VCC</span>
            <span class="pin pin-sig">SIG</span>
          </div>
        </label>

        <label class="servo-row">
          <input type="radio" name="servoPort" value="S2">
          <div class="servo-name">Servo S2</div>
          <div class="servo-pins">
            <span class="pin pin-gnd">GND</span>
            <span class="pin pin-vcc">VCC</span>
            <span class="pin pin-sig">SIG</span>
          </div>
        </label>

        <label class="servo-row">
          <input type="radio" name="servoPort" value="S3">
          <div class="servo-name">Servo S3</div>
          <div class="servo-pins">
            <span class="pin pin-gnd">GND</span>
            <span class="pin pin-vcc">VCC</span>
            <span class="pin pin-sig">SIG</span>
          </div>
        </label>

        <label class="servo-row">
          <input type="radio" name="servoPort" value="S4">
          <div class="servo-name">Servo S4</div>
          <div class="servo-pins">
            <span class="pin pin-gnd">GND</span>
            <span class="pin pin-vcc">VCC</span>
            <span class="pin pin-sig">SIG</span>
          </div>
        </label>
      </div>

      <div class="servo-actions">
        <button type="button" onclick="saveServoSelection()">Save</button>
        <button type="button" onclick="closeServoModal()">Cancel</button>
      </div>
    </div>
  </div>
  <!-- LED pin selection modal -->
  <div id="ledPinSelectionModal">
    <div class="box">
      <h3>Analog Pins</h3>

      <div class="box1">
        <div class="row"><label><input type="checkbox" id="ledPinC0"> C0</label></div>
        <div class="row"><label><input type="checkbox" id="ledPinC1"> C1</label></div>
        <div class="row"><label><input type="checkbox" id="ledPinC2"> C2</label></div>
        <div class="row"><label><input type="checkbox" id="ledPinF9"> F9</label></div>
        <div class="row"><label><input type="checkbox" id="ledPinA3"> A3</label></div>
        <div class="row"><label><input type="checkbox" id="ledPinF3"> F3</label></div>
        <div class="row"><label><input type="checkbox" id="ledPinF4"> F4</label></div>
      </div>
      <div class="box2">

        <div class="row"><label><input type="checkbox" id="ledPinF5"> F5</label></div>
        <div class="row"><label><input type="checkbox" id="ledPinC4"> C4</label></div>
        <div class="row"><label><input type="checkbox" id="ledPinC5"> C5</label></div>
        <div class="row"><label><input type="checkbox" id="ledPinA1"> A1</label></div>
        <div class="row"><label><input type="checkbox" id="ledPinA2"> A2</label></div>
        <div class="row"><label><input type="checkbox" id="ledPinA4"> A4</label></div>
        <div class="row"><label><input type="checkbox" id="ledPinF8"> F8</label></div>
        <div class="row"><label><input type="checkbox" id="ledPinA6"> A6</label></div>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button type="button" onclick="saveLedPinSelection()">Save</button>
        <button type="button" onclick="closeLedPinModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="wifiSettingsModal" style="display:none;">
    <div class="box">
      <h3>WiFi Configuration</h3>

      <div class="row" style="width: 100%; margin-bottom: 10px;">
        <input type="text" id="wifiSSID" placeholder="Enter SSID Name"
          style="width: 90%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
      </div>

      <div class="row" style="width: 100%; margin-bottom: 15px;">
        <input type="password" id="wifiPass" placeholder="Enter Password"
          style="width: 90%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button onclick="saveWifiSettings()">Save & Connect</button>
        <button onclick="closeWifiModal()">Cancel</button>
      </div>
    </div>
  </div>
  <script>

    let workspace = null;

    /* --- wait for Blockly --- */
    async function waitForBlockly(timeoutMs = 5000) {
      const t0 = Date.now();
      while (!(window.__blocklyLoaded && window.Blockly && Blockly.Python)) {
        await new Promise(r => setTimeout(r, 50));
        if (Date.now() - t0 > timeoutMs) break;
      }
      return !!(window.__blocklyLoaded && window.Blockly && Blockly.Python);
    }

    // ---------------block creation is here-------------------
    /* --- define blocks (including modal-driven blocks) --- */
    function defineBlocks() {
      Blockly.defineBlocksWithJsonArray([
        {
          type: "start",
          message0: "Start %1 return %2",
          args0: [{
            type: "input_statement",
            name: "DO"
          },
          {
            type: "input_value",
            name: "VALUE"
          }
          ],
          nextStatement: null,
          extensions: ["defult_style"]
        },
        {
          type: "port_on",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/robo.png",
              width: 35,
              height: 35,
              alt: "",
              name: "IMG1",
              class: "hover-animate"
            },
            {
              type: "field_label",
              name: "LABEL",
              text: "Digi ON"
            },
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG",
              class: "hover-animate"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }
          ],
          message0: "%1 %2 %3 %4",
          colour: "#ffb56a",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_on_img_click", "led_style"]
        },
        {
          type: "port_off",
          message0: "DigitalOut OFF %1 %2",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }
          ],
          colour: "#ffb56a",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "led_style"]
        },
        {
          type: "sen_ultrasonic",
          message0: "ultrasonic distance on port %1",
          args0: [
            {
              type: "field_number",
              name: "PORT",
              value: 2,
              min: 0,
              max: 99
            }
          ],
          style: "control_blocks",
          previousStatement: null,
          nextStatement: null,
          extensions: ["led_style"]
        },
        {
          type: "sen_temp",
          message0: "temperature on port %1 %2",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }
          ],
          style: "control_blocks",
          previousStatement: null,
          nextStatement: null,
          extensions: ["led_style", 'led_pin_image_click']
        },
        {
          type: "do_onoff",
          message0: "digital write pins %1 %2 %3",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["ON", "1"],
                ["OFF", "0"]
              ]
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "servo_color"]
        },
        {
          type: "do_dc_motor",
          message0: "DC Motor %1 %2 %3 %4 %5",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "MOTORS",
              text: ""
            },
            {
              type: "field_number",
              name: "SPEED",
              value: 60,
              min: 0
            },
            {
              type: "field_label",
              text: "%"
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["forward", "forward"],
                ["backward", "backward"],
                ["stop", "stop"]
              ]
            },
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["motor_image_click", "servo_color"]
        },
        {
          type: "do_servo",
          message0: "servo on %1 %2 %3 %4",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "SERVO_PORT",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["forward", "forward"],
                ["backward", "backward"]
              ]
            },
            {
              type: "field_number",
              name: "ANG",
              value: 90,
              min: 0,
              max: 180,
              precision: 1
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["servo_image_click", "servo_color"]
        },
        {
          type: "bt_send",
          message0: "Bluetooth send %1",
          args0: [
            {
              type: "input_value",
              name: "TEXT"
            }
          ],
          previousStatement: null,
          nextStatement: null,
          style: "control_blocks",
          extensions: ["servo_color"]
        },
        {
          type: "do_led",
          message0: "LED %1 %2 %3",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["ON", "1"],
                ["OFF", "0"]
              ]
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "servo_color"]
        },
        {
          type: "ctl_delay",
          message0: "delay %1 ms",
          args0: [{
            type: "field_number",
            name: "MS",
            value: 500,
            min: 0,
            max: 600000
          }],
          style: "led_blocks",
          previousStatement: null,
          nextStatement: null,
          extensions: ["dummy_style"]
        },
        {
          type: "lp_while",
          message0: "while %1",
          args0: [{ type: "input_value", name: "COND", check: "Boolean" }],
          message1: "do %1",
          args1: [{ type: "input_statement", name: "DO" }],

          previousStatement: null,
          nextStatement: null,
          extensions: ["dc_color"]
        },
        {
          type: "lp_break",
          message0: "break",

          previousStatement: null,
          nextStatement: null,
          extensions: ["dc_color"]

        },
        {
          type: "lp_start",
          message0: "@@start",

          previousStatement: null,
          nextStatement: null,
          extensions: ["dc_color"]

        },
        {
          type: "lp_repeat_count",
          message0: "repeat %1 %2 times",
          args0: [
            {
              type: 'field_number',
              name: "PIN"
            }, {
              type: "field_number",
              name: "COUNT", value: 4, min: 0, max: 100000
            }],
          message1: "do %1",
          args1: [{
            type: "input_statement",
            name: "DO"
          }],
          previousStatement: null,
          nextStatement: null,
          extensions: ["dc_color"]
        },
        {
          type: "lp_label",
          message0: "label %1",
          args0: [{
            type: "field_input",
            name: "NAME",
            text: "lbl1"
          }],
          previousStatement: null,
          nextStatement: null,
          extensions: ["dc_color"]
        },
        {
          type: "din_if_else",
          message0: "if %1",
          args0: [{ type: "input_value", name: "COND", check: "Boolean" }],
          message1: "do %1",
          args1: [{ type: "input_statement", name: "DO" }],
          message2: "else %1",
          args2: [{ type: "input_statement", name: "ELSE" }],
          style: "control_blocks",
          previousStatement: null,
          nextStatement: null,
          extensions: ["temp_style"]
        },
        {
          type: "din_sound",
          message0: "SOUND CELL %1 %2",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["temp_style", "port_image_click"]
        }
        ,
        {
          type: "din_tilt",
          message0: "TILT %1 %2",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["temp_style", "port_image_click"]
        },
        {
          type: "din_door",
          message0: "MAGNETIC SWITCH %1 %2",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["temp_style", "port_image_click"]
        },
        {
          type: "din_button",
          message0: "BUTTON %1 %2",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["temp_style", "port_image_click"]
        },
        {
          type: "din_motion",
          message0: "MOTION SENSOR %1 %2",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["temp_style", "port_image_click"]
        },
        {
          type: "din_proximity",
          message0: "PROXIMITY %1 %2",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["temp_style", "port_image_click"]
        },
        {
          type: "din_ir",
          message0: "IR %1 %2",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["temp_style", "port_image_click"]
        },
        {
          type: "din_flame",
          message0: "FLAME %1 %2",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["temp_style", "port_image_click"]
        },
        {
          type: "load_cell",
          message0: "Load Cell %1 %2",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["temp_style", "port_image_click"]
        },
        {
          type: "ultra_sonic",
          message0: "ultra sonic %1 %2",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["temp_style", "port_image_click"]
        },

        {
          type: "do_led_param",
          message0: "LED write %1 %2 value %3 time %4",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",   // keep PORTS here
              text: ""
            },
            {
              type: "input_value",
              name: "VAL"
            },
            {
              type: "input_value",
              name: "VAL2"
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["led_pin_image_click", "dummy_style"]
        },
        {
          type: "mini_motor",
          message0: "Mini Motor %1 %2 %3 %4",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "MOTORS",
              text: ""
            },
            {
              type: "field_number",
              name: "SPEED",
              value: 60,
              min: -100,
              max: 100,
              precision: 1
            },
            {
              type: "field_label",
              text: "%"
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["motor_image_click", "temp_style"]
        },
        {
          type: "remote_motor",
          message0: "remote Motor %1 %2 %3 %4",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "MOTORS",
              text: ""
            },
            {
              type: "field_number",
              name: "SPEED",
              value: 10,
              min: -100,
              max: 100,
              precision: 1
            },
            {
              type: "field_label",
              text: "%"
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["motor_image_click", "temp_style"]
        },
        {
          type: "water_motor",
          message0: "water Motor %1 %2 %3 %4",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "MOTORS",
              text: ""
            },
            {
              type: "field_number",
              name: "SPEED",
              value: 40,
              min: -100,
              max: 100,
              precision: 1
            },
            {
              type: "field_label",
              text: "%"
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["motor_image_click", "temp_style"]
        },
        {
          type: "tank_motor",
          message0: "tank Motor %1 %2 %3 %4",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "MOTORS",
              text: ""
            },
            {
              type: "field_number",
              name: "SPEED",
              value: 40,
              min: -100,
              max: 100,
              precision: 1
            },
            {
              type: "field_label",
              text: "%"
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["motor_image_click", "temp_style"]
        },
        {
          type: "sensor",
          message0: "ultra sonic %1 %2 %3",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["ON", "1"],
                ["OFF", "0"]
              ]
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "ultra_style"]
        },
        {
          type: "tem_sensor",
          message0: "tem sonic %1 %2 %3",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["ON", "1"],
                ["OFF", "0"]
              ]
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "ultra_style"]
        },
        {
          type: "xray_sensor",
          message0: "xray sonic %1 %2 %3",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["ON", "1"],
                ["OFF", "0"]
              ]
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "ultra_style"]
        },
        {
          type: "rc_sensor",
          message0: "rc sensor %1 %2 %3",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["ON", "1"],
                ["OFF", "0"]
              ]
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "ultra_style"]
        },
        {
          type: "sensor",
          message0: "rc sensor %1 %2 %3",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["ON", "1"],
                ["OFF", "0"]
              ]
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "ultra_style"]
        },
        {
          type: 'logical_comparison',
          message0: '%1 %2 %3',
          args0: [
            {
              type: 'input_value',
              name: 'VALUE1'
            },
            {
              type: 'field_dropdown',
              name: 'OPERATOR',
              options: [
                ['<', '<'],
                ['>', '>'],
                ['==', '=='],
                ['>=', '>='],
                ['<=', '<='],
                ['!=', '!=']
              ]
            },
            {
              type: 'input_value',
              name: 'VALUE2'
            }
          ],
          colour: '#4C97FF',
          output: 'Boolean',
          inputsInline: true
        }, {
          type: 'red_led',
          message0: "Red LED %1 %2 %3 %4",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_number",
              name: "VAL1",
              value: 1,
              min: 0,
              max: 100,
              precision: 1
            },
            {
              type: "field_number",
              name: "VAL2",
              value: 1,
              min: 0,
              max: 100,
              precision: 1
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["led_pin_image_click", "dummy_style"]
        },
        {
          type: 'yellow_led',
          message0: "YELLOW LED %1 %2 %3 %4",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_number",
              name: "VAL1",
              value: 1,
              min: 0,
              max: 100,
              precision: 1
            },
            {
              type: "field_number",
              name: "VAL2",
              value: 1,
              min: 0,
              max: 100,
              precision: 1
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["led_pin_image_click", "dummy_style"]
        },
        {
          type: 'green_led',
          message0: "GREEN LED %1 %2 %3 %4",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_number",
              name: "VAL1",
              value: 1,
              min: 0,
              max: 100,
              precision: 1
            },
            {
              type: "field_number",
              name: "VAL2",
              value: 1,
              min: 0,
              max: 100,
              precision: 1
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["led_pin_image_click", "dummy_style"]
        },
        {
          type: "sensor1",
          message0: "ultra sonic %1 %2 %3",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["ON", "1"],
                ["OFF", "0"]
              ]
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "ultra_style"]
        }, {
          type: "sensor2",
          message0: "ultra sonic %1 %2 %3",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["ON", "1"],
                ["OFF", "0"]
              ]
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "ultra_style"]
        },
        {
          type: "sensor3",
          message0: "ultra sonic %1 %2 %3",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["ON", "1"],
                ["OFF", "0"]
              ]
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "ultra_style"]
        },
        {
          type: "sensor4",
          message0: "ultra sonic %1 %2 %3",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["ON", "1"],
                ["OFF", "0"]
              ]
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "ultra_style"]
        },
        {
          type: "sensor5",
          message0: "ultra sonic %1 %2 %3",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["ON", "1"],
                ["OFF", "0"]
              ]
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "ultra_style"]
        },
        {
          type: "sensor6",
          message0: "ultra sonic %1 %2 %3",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["ON", "1"],
                ["OFF", "0"]
              ]
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "ultra_style"]
        },
        {
          type: "steper",
          message0: "steper Motor %1 %2 %3",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_number",
              name: "SPEED",
              value: 60,
              min: 0,
              max: 100,
            },
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "servo_color"]
        },
        {
          type: "waterpump",
          message0: "Water Pump %1 %2 Angle %3 ¬∞",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_number",
              name: "ANGLE",
              value: 60,
              min: 0
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "servo_color"]
        },
        {
          type: "solinoid",
          message0: "Solinoid Valve %1 %2 Value %3 ",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["0", "0"],
                ["1", "1"]
              ]
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "servo_color"]
        },
        {
          type: "animo",
          message0: "Anemo Meter %1 %2 Value %3 ",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["0", "0"],
                ["1", "1"]
              ]
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "servo_color"]
        },
        {
          type: "relay",
          message0: "Relay %1 %2 Value %3 ",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["0", "0"],
                ["1", "1"]
              ]
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "servo_color"]
        },
        {
          type: "loop_end",
          message0: "End the Loop %1",
          args0: [
            {
              type: "field_input",
              name: "NAME",
              text: ""
            }],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["temp_style", "port_image_click"]
        },
        {
          type: "buzzer",
          message0: "buzzer %1 %2 %3 %4 %5",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_number",
              name: "VAL1",
            },
            {
              type: "field_number",
              name: "VAL2",
            },
            {
              type: "field_number",
              name: "VAL3",
            },

          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "servo_color"]
        },
        {
          type: "minifan",
          message0: "Mini fan %1 %2 %3",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["forward", "forward"],
                ["backward", "backward"],
                ["stop", "stop"]
              ]
            },

          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "servo_color"]
        },
        {
          type: "rgb_component",
          message0: "rgb_component %1 %2 %3 %4 %5",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_nUmber",
              name: "freq",
              value: 0,

            },
            {
              type: "field_number",
              name: "Delay1",
              value: 255,
            }
            , {
              type: "field_number",
              name: "DELAY2",
              value: 0,

            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "servo_color"]
        },
        {
          type: "shock_sensor",
          message0: "Shock Sensor %1 %2",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["servo_color", "led_pin_image_click"]
        },
        {
          type: "flex-sensor",
          message0: "flex %1 %2 ",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },

          ],
          output: "Boolean",
          extensions: ["led_pin_image_click", "servo_color"]
        },
        {
          type: "buzzer_component",
          message0: "buzzer_component %1 %2 %3 %4 %5",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_number",
              name: "freq",
              value: 1,

            },
            {
              type: "field_number",
              name: "Delay1",
              value: 1000,
            }
            , {
              type: "field_number",
              name: "DELAY2",
              value: 1000,

            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "servo_color"]
        },
        {
          type: "relay",
          message0: "relay Valve %1 %2 Value %3 ",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            },
            {
              type: "field_dropdown",
              name: "STATE",
              options: [
                ["0", "0"],
                ["1", "1"]
              ]
            }
          ],
          colour: "#81d4ed",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_on_img_click", "servo_color"]
        },
        {
          type: "joystick_move",
          args0: [

            {
              type: "field_label",
              name: "LABEL",
              text: "joystick"
            },
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG",
              class: "hover-animate"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }
          ],
          message0: "%1 %2 %3",
          colour: "#ffb56a",
          previousStatement: null,
          nextStatement: null,
          extensions: ["port_image_click", "servo_color"]
        },
        {
          type: "Air_quality_sensor",
          message0: "Air-quality-sensor  %1 %2",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["servo_color", "led_pin_image_click"]
        },
        {
          type: "flexi_force_sensor",
          message0: "Flexi Force Sensor %1 %2",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["servo_color", "led_pin_image_click"]
        }, {
          type: "TDS_Water_sensor",
          message0: "TDS Water Sensor %1 %2",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["servo_color", "led_pin_image_click"]
        },
        {
          type: "LCD_print",
          message0: "LCD_DUMMY send %1",
          args0: [
            {
              type: "input_value",
              name: "TEXT"
            }
          ],
          previousStatement: null,
          nextStatement: null,
          extensions: ["servo_color"]
        },
        {
          type: "din_bo",
          message0: "button pin %1 %2",
          args0: [

            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",   // keep PORTS here
              text: ""
            }
          ],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["port_on_img_click", "servo_color"]
        },
        {
          type: "din_flame",
          message0: "flame sensor pin %1 %2",
          args0: [

            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",   // keep PORTS here
              text: ""
            }
          ],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["led_pin_image_click", "servo_color"]
        },
        {
          type: "din_temp",
          message0: "temperature sensor pin %1 %2",
          args0: [

            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",   // keep PORTS here
              text: ""
            }
          ],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["servo_color", "led_pin_image_click"]
        },
        {
          type: "water_sensor",
          message0: "Water Sensor %1 %2",
          args0: [
            {
              type: "field_image",
              src: "./assets/img/Chips_Chips_Show.png",
              width: 15,
              height: 15,
              alt: "",
              name: "IMG"
            },
            {
              type: "field_label",
              name: "PORTS",
              text: ""
            }],
          style: "control_blocks",
          output: "Boolean",
          extensions: ["servo_color", "led_pin_image_click"]
        },
        {
          "type": "any_input_block",
          "message0": "%1",
          "args0": [
            {
              "type": "field_input",
              "name": "ANY",
              "text": "1"
            }
          ],
          "output": null,
          "colour": 230,
          "tooltip": "Accepts string, number, symbols",
          "helpUrl": ""
        },
        // {
        //   type: "rgb_display",
        //   message0: "display %1 %2 %3 %4 %5",
        //   args0: [
        //     {
        //       type: "field_colour",
        //       name: "RED",
        //       colour: "#FF0000"
        //     },
        //     {
        //       type: "field_colour",
        //       name: "ORANGE",
        //       colour: "#FFA500"
        //     },
        //     {
        //       type: "field_colour",
        //       name: "YELLOW",
        //       colour: "#FFFF00"
        //     },
        //     {
        //       type: "field_colour",
        //       name: "GREEN",
        //       colour: "#008000"
        //     },
        //     {
        //       type: "field_colour",
        //       name: "CYAN",
        //       colour: "#00FFFF"
        //     }
        //   ],
        //   colour: 160,
        //   tooltip: "Displays RGB colors",
        //   helpUrl: "",
        //   previousStatement: null,
        //   nextStatement: null,
        //   extensions: ["servo_color"]
        // },
        // {
        //   "type": "rgb_led_display",
        //   "message0": "LED %1 displays %2 for %3 seconds %4 %5",
        //   "args0": [
        //     {
        //       "type": "field_dropdown",
        //       "name": "LED",
        //       "options": [
        //         ["all", "ALL"],
        //         ["1", "1"],
        //         ["2", "2"],
        //         ["3", "3"]
        //       ]
        //     },
        //     {
        //       "type": "field_colour",
        //       "name": "COLOR",
        //       "colour": "#FF0000"
        //     },
        //     {
        //       "type": "field_slider",
        //       "name": "SATURATION",
        //       "min": 0,
        //       "max": 100,
        //       "value": 99,
        //       "step": 1,
        //       "precision": 0
        //     },
        //     {
        //       "type": "field_slider",
        //       "name": "BRIGHTNESS",
        //       "min": 0,
        //       "max": 100,
        //       "value": 72,
        //       "step": 1,
        //       "precision": 0
        //     },
        //     {
        //       "type": "input_value",
        //       "name": "TIME"
        //     }
        //   ],
        //   "colour": 160,
        //   "tooltip": "Displays an LED with customizable color, saturation, and brightness",
        //   "helpUrl": "",
        //   previousStatement: null,
        //   nextStatement: null,
        //   extensions: ["servo_color"]
        // }
      ]);


      // -----------------this is popup block img  clickable function-----------------------

      Blockly.Extensions.register('port_on_img_click', function () {
        const imgField = this.getField('IMG');
        if (!imgField) return;
        imgField.setOnClickHandler(() => {
          openPortSelectionModal(this);
        });
      });

      Blockly.Extensions.register('port_image_click', function () {
        const imgField = this.getField('IMG');
        if (!imgField) return;
        imgField.setOnClickHandler(() => {
          openPortSelectionModal(this);
        });
      });

      Blockly.Extensions.register('motor_image_click', function () {
        const imgField = this.getField('IMG');
        imgField.setOnClickHandler(() => {
          openMotorSelectionModal(this);
        });
      });

      Blockly.Extensions.register('servo_image_click', function () {
        const imgField = this.getField('IMG');
        if (!imgField) return;
        imgField.setOnClickHandler(() => {
          openServoSelectionModal(this);
        });
      });

      /* ===== BORDER / TYPE CLASS EXTENSIONS (for gradients) ===== */
      // -----------------ADD GRADIENT COLOR FOR BLOCK HERE-------------------

      Blockly.Extensions.register('defult_style', function () {
        const block = this;
        block.setOnChange(function () {
          if (block.svgGroup_) {
            block.svgGroup_.classList.add('defult_style');
          }
        });
      });

      Blockly.Extensions.register('servo_color', function () {
        const block = this;
        block.setOnChange(function () {
          if (block.svgGroup_) {
            block.svgGroup_.classList.add('block-servo');
          }
        });
      });
      Blockly.Extensions.register('led_pin_image_click', function () {
        const imgField = this.getField('IMG');
        if (!imgField) return;
        imgField.setOnClickHandler(() => {
          openLedPinSelectionModal(this);
        });
      });
      Blockly.Extensions.register('led_style', function () {
        const block = this;
        block.setOnChange(function () {
          if (block.svgGroup_) {
            block.svgGroup_.classList.add('led_style');
          }
        })
      })
      Blockly.Extensions.register('dummy_style', function () {
        const block = this;
        block.setOnChange(function () {
          if (block.svgGroup_) {
            block.svgGroup_.classList.add('dummy_block');
          }
        })
      })
      Blockly.Extensions.register('temp_style', function () {
        const block = this;
        block.setOnChange(function () {
          if (block.svgGroup_) {
            block.svgGroup_.classList.add('temp_style')
          }
        })
      })
      Blockly.Extensions.register('dc_color', function () {
        const block = this;
        block.setOnChange(function () {
          if (__blocklyLoaded) {
            block.svgGroup_.classList.add('block_dc')
          }
        })
      })
      Blockly.Extensions.register('ultra_style', function () {
        const block = this;
        block.setOnChange(function () {
          if (block.svgGroup_) {
            block.svgGroup_.classList.add('ultra_style')
          }
        })
      })


    }


    //----------------Python CODE GENERATOR-------------------
    /* --- generators --- */
    function defineGenerators() {
      const py = Blockly.Python;
      Blockly.Python['do_led'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';
        const stateVal = block.getFieldValue('STATE') || '0';

        const ports = portsTxt
          .split(',')
          .map(s => s.trim())
          .filter(Boolean);

        if (!ports.length) {
          return "# do_led: no ports selected\n";
        }

        const fn = (stateVal === '1') ? 'robot.led_on' : 'robot.led_off';

        return ports.map(p => `${fn}(${p})\n`).join('');
      };
      Blockly.Python['bt_send'] = function (block) {
        const txt = Blockly.Python.valueToCode(block, 'TEXT', Blockly.Python.ORDER_NONE) || "''";
        // Example: send text over Bluetooth
        return `robot.bt_send(${txt})\n`;
      };
      Blockly.Python['sen_ultrasonic'] = function (block) {
        const port = block.getFieldValue('PORT') || 0;
        // Statement style: maybe store or print the distance
        return `distance = robot.ultrasonic_cm(${port})\n`;
      };

      Blockly.Python['sen_temp'] = function (block) {
        const pinsTxt = block.getFieldValue('PORTS') || "";

        const pins = pinsTxt.split(',').map(s => s.trim()).filter(Boolean);

        if (!pins.length) {
          return "# tem_port: no pins selected\n";
        }

        let code = '';
        pins.forEach(pin => {
          // using 'D3' style names:
          code += `temp_port(${pin})\n`;
        });

        // example: store temperature into a global variable "temperature"
        return code;
      };


      Blockly.Python['do_onoff'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';
        const stateVal = block.getFieldValue('STATE') || '0';

        const ports = portsTxt
          .split(',')
          .map(s => s.trim())
          .filter(Boolean);

        if (!ports.length) {
          return "# do_onoff: no ports selected\n";
        }

        const fn = (stateVal === '1') ? 'robot.port_on' : 'robot.port_off';
        return ports.map(p => `${fn}(${p})\n`).join('');
      };

      Blockly.Python['port_on'] = function (block) {
        var ports = block.getFieldValue('PORTS');
        var portList = ports.split(',').map(s => s.trim());
        var code = '';
        portList.forEach(function (port) {
          code += `robot.port_on(${port})\n`;
        });
        return code;
      };

      Blockly.Python['port_off'] = function (block) {
        var ports = block.getFieldValue('PORTS');
        var portList = ports.split(',').map(s => s.trim());
        var code = '';
        portList.forEach(function (port) {
          code += `robot.port_off(${port})\n`;
        });
        return code;
      };

      Blockly.Python['do_dc_motor'] = function (block) {
        const speed = block.getFieldValue('SPEED') || 0;
        const motors = (block.getFieldValue('MOTORS') || '').split(',').map(s => s.trim()).filter(Boolean);
        const state = block.getFieldValue('STATE')
        if (motors.length === 0) {
          return "# No motors selected\n";
        }

        let code = "";
        motors.forEach(motor => {
          code += `control_motor("${motors}",${speed},${state})\n`;
        });

        return code;
      };

      Blockly.Python['start'] = function (block) {
        const body =
          Blockly.Python.statementToCode(block, 'DO') || '    pass\n';

        const value =
          Blockly.Python.valueToCode(
            block,
            'VALUE',
            Blockly.Python.ORDER_NONE
          );//|| 'None';

        return `def start(${value}):\n${body} \n`;
      };

      Blockly.Python['do_servo'] = function (block) {
        const servoPort = block.getFieldValue('SERVO_PORT') || '';
        const angle = block.getFieldValue('ANG') || 0;
        const state = block.getFieldValue('STATE')

        if (!servoPort) {
          return "# do_servo: no servo port selected\n";
        }
        return `control.servo('${servoPort}',${state},${angle})\n`;
      };

      Blockly.Python['ctl_delay'] = function (block) {
        const ms = block.getFieldValue('MS') || 0;
        return `robot.delay_ms(${ms})\n`;
      };

      py['lp_while'] = b => {
        const cond = py.valueToCode(b, 'COND', py.ORDER_NONE) || 'False';
        const body = py.statementToCode(b, 'DO') || '  pass\n';
        return `while ${cond}:\n${body}`;
      };

      py['lp_break'] = () => '@@END\n';
      py['lp_start'] = () => '@@START\n';

      py['lp_repeat_count'] = b => {
        const n1 = +b.getFieldValue("PIN") || 0;
        const n = +b.getFieldValue('COUNT') || 0;
        const body = py.statementToCode(b, 'DO') || '  pass\n';
        return `for _ in range(${n}):\n${body}`;
      };

      py['lp_label'] = b => `# label: ${b.getFieldValue('NAME') || 'lbl1'}\n`;

      Blockly.Python['din_if_else'] = function (block) {
        const condition = Blockly.Python.valueToCode(block, 'COND', Blockly.Python.ORDER_NONE) || 'False';  // Ensure Boolean
        const doStatements = Blockly.Python.statementToCode(block, 'DO') || '  pass\n';  // The 'do' part
        const elseStatements = Blockly.Python.statementToCode(block, 'ELSE') || '  pass\n';  // The 'else' part

        return `if ${condition}:\n${doStatements}else: \n ${elseStatements} \n`;
      };



      Blockly.Python['do_led_param'] = function (block) {
        const pinsTxt = block.getFieldValue('PORTS') || '';   // üî¥ PINS ‚Üí PORTS

        const valueCode1 =
          Blockly.Python.valueToCode(block, 'VAL', Blockly.Python.ORDER_NONE) || '0';

        const valueCode2 =
          Blockly.Python.valueToCode(block, 'VAL2', Blockly.Python.ORDER_NONE) || '0';

        const pins = pinsTxt.split(',').map(s => s.trim()).filter(Boolean);

        if (!pins.length) {
          return "# do_led_param: no pins selected\n";
        }

        let code = '';
        pins.forEach(pin => {
          // using 'D3' style names:
          code += `led_blink('${pin}', ${valueCode1}, ${valueCode2})\n`;
        });

        return code;
      };


      Blockly.Python['logical_comparison'] = function (block) {
        var value1 = Blockly.Python.valueToCode(block, 'VALUE1', Blockly.Python.ORDER_NONE);
        var operator = block.getFieldValue('OPERATOR');
        var value2 = Blockly.Python.valueToCode(block, 'VALUE2', Blockly.Python.ORDER_NONE);

        var code = `${value1} ${operator} ${value2}`;
        return [code, Blockly.Python.ORDER_RELATIONAL];
      };


      Blockly.Python['red_led'] = function (block) {
        const pinsTxt = block.getFieldValue('PORTS') || '';   // üî¥ PINS ‚Üí PORTS

        const val1 = block.getFieldValue('VAL1') || 1;
        const val2 = block.getFieldValue('VAL2') || 1;

        const pins = pinsTxt.split(',').map(s => s.trim()).filter(Boolean);

        if (!pins.length) {
          return "# red_blink: no pins selected\n";
        }

        let code = '';
        pins.forEach(pin => {
          // using 'D3' style names:
          code += `red_blink("${pin}", ${val1}, ${val2})\n`;
        });

        return code;
      };
      Blockly.Python['yellow_led'] = function (block) {
        const pinsTxt = block.getFieldValue('PORTS') || '';   // üî¥ PINS ‚Üí PORTS

        const val1 = block.getFieldValue('VAL1') || 1;
        const val2 = block.getFieldValue('VAL2') || 1;

        const pins = pinsTxt.split(',').map(s => s.trim()).filter(Boolean);

        if (!pins.length) {
          return "# Green_blink: no pins selected\n";
        }

        let code = '';
        pins.forEach(pin => {
          // using 'D3' style names:
          code += `yellow_blink("${pin}", ${val1},${val2})\n`;
        });

        return code;
      };
      Blockly.Python['green_led'] = function (block) {
        const pinsTxt = block.getFieldValue('PORTS') || '';   // üî¥ PINS ‚Üí PORTS

        const val1 = block.getFieldValue('VAL1') || 1;
        const val2 = block.getFieldValue('VAL2') || 1;

        const pins = pinsTxt.split(',').map(s => s.trim()).filter(Boolean);

        if (!pins.length) {
          return "# Green_blink: no pins selected\n";
        }

        let code = '';
        pins.forEach(pin => {
          // using 'D3' style names:
          code += `green_blink("${pin}", ${val1},${val2})\n`;
        });

        return code;
      };

      Blockly.Python['din_sound'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';

        // Split ports like "D3,H1"
        const pins = portsTxt
          .split(',')
          .map(p => p.trim())
          .filter(Boolean);

        // If no ports are selected, show a warning message
        if (!pins.length) {
          return ['# Invalid: Please select at least one port', Blockly.Python.ORDER_NONE];
        }

        // If one port is selected, return code for that port only
        if (pins.length === 1) {
          return [`get_sound("${pins[0]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If two ports are selected, use both for Trig and Echo
        if (pins.length === 2) {
          return [`get_sound("${pins[0]}","${pins[1]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If more than two ports are selected, return the first two only
        return [`get_sound("${pins[0]}","${pins[1]}","${pins[2]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
      };
      Blockly.Python['din_tilt'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';

        // Split ports like "D3,H1"
        const pins = portsTxt
          .split(',')
          .map(p => p.trim())
          .filter(Boolean);

        // If no ports are selected, show a warning message
        if (!pins.length) {
          return ['# Invalid: Please select at least one port', Blockly.Python.ORDER_NONE];
        }

        // If one port is selected, return code for that port only
        if (pins.length === 1) {
          return [`get_tilt("${pins[0]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If two ports are selected, use both for Trig and Echo
        if (pins.length === 2) {
          return [`get_tilt("${pins[0]}","${pins[1]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If more than two ports are selected, return the first two only
        return [`get_tilt("${pins[0]}","${pins[1]}","${pins[2]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
      };
      Blockly.Python['din_door'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';

        // Split ports like "D3,H1"
        const pins = portsTxt
          .split(',')
          .map(p => p.trim())
          .filter(Boolean);

        // If no ports are selected, show a warning message
        if (!pins.length) {
          return ['# Invalid: Please select at least one port', Blockly.Python.ORDER_NONE];
        }

        // If one port is selected, return code for that port only
        if (pins.length === 1) {
          return [`get_door("${pins[0]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If two ports are selected, use both for Trig and Echo
        if (pins.length === 2) {
          return [`get_door("${pins[0]}","${pins[1]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If more than two ports are selected, return the first two only
        return [`get_door("${pins[0]}","${pins[1]}","${pins[2]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
      };
      Blockly.Python['din_button'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';

        // Split ports like "D3,H1"
        const pins = portsTxt
          .split(',')
          .map(p => p.trim())
          .filter(Boolean);

        // If no ports are selected, show a warning message
        if (!pins.length) {
          return ['# Invalid: Please select at least one port', Blockly.Python.ORDER_NONE];
        }

        // If one port is selected, return code for that port only
        if (pins.length === 1) {
          return [`get_button("${pins[0]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If two ports are selected, use both for Trig and Echo
        if (pins.length === 2) {
          return [`get_button("${pins[0]}","${pins[1]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If more than two ports are selected, return the first two only
        return [`get_button("${pins[0]}","${pins[1]}","${pins[2]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
      };
      Blockly.Python['din_motion'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';

        // Split ports like "D3,H1"
        const pins = portsTxt
          .split(',')
          .map(p => p.trim())
          .filter(Boolean);

        // If no ports are selected, show a warning message
        if (!pins.length) {
          return ['# Invalid: Please select at least one port', Blockly.Python.ORDER_NONE];
        }

        // If one port is selected, return code for that port only
        if (pins.length === 1) {
          return [`get_motion("${pins[0]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If two ports are selected, use both for Trig and Echo
        if (pins.length === 2) {
          return [`get_motion("${pins[0]}","${pins[1]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If more than two ports are selected, return the first two only
        return [`get_motion("${pins[0]}","${pins[1]}","${pins[2]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
      };
      Blockly.Python['din_proximity'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';

        // Split ports like "D3,H1"
        const pins = portsTxt
          .split(',')
          .map(p => p.trim())
          .filter(Boolean);

        // If no ports are selected, show a warning message
        if (!pins.length) {
          return ['# Invalid: Please select at least one port', Blockly.Python.ORDER_NONE];
        }

        // If one port is selected, return code for that port only
        if (pins.length === 1) {
          return [`get_proximity("${pins[0]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If two ports are selected, use both for Trig and Echo
        if (pins.length === 2) {
          return [`get_proximity("${pins[0]}","${pins[1]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If more than two ports are selected, return the first two only
        return [`get_proximity("${pins[0]}","${pins[1]}","${pins[2]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
      };


      Blockly.Python['din_ir'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';

        // Split ports like "D3,H1"
        const pins = portsTxt
          .split(',')
          .map(p => p.trim())
          .filter(Boolean);

        // If no ports are selected, show a warning message
        if (!pins.length) {
          return ['# Invalid: Please select at least one port', Blockly.Python.ORDER_NONE];
        }

        // If one port is selected, return code for that port only
        if (pins.length === 1) {
          return [`get_ir("${pins[0]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If two ports are selected, use both for Trig and Echo
        if (pins.length === 2) {
          return [`get_ir("${pins[0]}","${pins[1]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If more than two ports are selected, return the first two only
        return [`get_ir("${pins[0]}","${pins[1]}","${pins[2]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
      };
      Blockly.Python['din_flame'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';

        // Split ports like "D3,H1"
        const pins = portsTxt
          .split(',')
          .map(p => p.trim())
          .filter(Boolean);

        // If no ports are selected, show a warning message
        if (!pins.length) {
          return ['# Invalid: Please select at least one port', Blockly.Python.ORDER_NONE];
        }

        // If one port is selected, return code for that port only
        if (pins.length === 1) {
          return [`get_flame("${pins[0]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If two ports are selected, use both for Trig and Echo
        if (pins.length === 2) {
          return [`get_flame("${pins[0]}","${pins[1]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If more than two ports are selected, return the first two only
        return [`get_flame("${pins[0]}","${pins[1]}","${pins[2]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
      };
      Blockly.Python['load_cell'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';

        // Split ports like "D3,H1"
        const pins = portsTxt
          .split(',')
          .map(p => p.trim())
          .filter(Boolean);

        // If no ports are selected, show a warning message
        if (!pins.length) {
          return ['# Invalid: Please select at least one port', Blockly.Python.ORDER_NONE];
        }

        // If one port is selected, return code for that port only
        if (pins.length === 1) {
          return [`load_cell("${pins[0]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If two ports are selected, use both for Trig and Echo
        if (pins.length === 2) {
          return [`load_cell("${pins[0]}","${pins[1]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If more than two ports are selected, return the first two only
        return [`load_cell("${pins[0]}","${pins[1]}","${pins[2]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
      };

      Blockly.Python['ultra_sonic'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';

        // Split ports like "D3,H1"
        const pins = portsTxt
          .split(',')
          .map(p => p.trim())
          .filter(Boolean);

        // If no ports are selected, show a warning message
        if (!pins.length) {
          return ['# Invalid: Please select at least one port', Blockly.Python.ORDER_NONE];
        }

        // If one port is selected, return code for that port only
        if (pins.length === 1) {
          return [`ultra_sonic("${pins[0]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If two ports are selected, use both for Trig and Echo
        if (pins.length === 2) {
          return [`ultra_sonic("${pins[0]}","${pins[1]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If more than two ports are selected, return the first two only
        return [`ultra_sonic("${pins[0]}","${pins[1]}","${pins[2]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
      };
      Blockly.Python['mini_motor'] = function (block) {
        const speed = block.getFieldValue('SPEED') || 0;
        const motors = (block.getFieldValue('MOTORS') || '').split(',').map(s => s.trim()).filter(Boolean);

        if (motors.length === 0) {
          return "# No motors selected\n";
        }

        let code = "";
        motors.forEach(motor => {
          code += `red_blink("F4",1,1)\n`;
        });

        return code;
      };
      Blockly.Python['remote_motor'] = function (block) {
        const speed = block.getFieldValue('SPEED') || 0;
        const motors = (block.getFieldValue('MOTORS') || '').split(',').map(s => s.trim()).filter(Boolean);

        if (motors.length === 0) {
          return "# No motors selected\n";
        }

        let code = "";
        motors.forEach(motor => {
          code += `yellow_blink("G5",1,1)\n`;
        });

        return code;
      };
      Blockly.Python['water_motor'] = function (block) {
        const speed = block.getFieldValue('SPEED') || 0;
        const motors = (block.getFieldValue('MOTORS') || '').split(',').map(s => s.trim()).filter(Boolean);

        if (motors.length === 0) {
          return "# No motors selected\n";
        }

        let code = "";
        motors.forEach(motor => {
          code += `green_blink("B15",1,1)\n`;
        });

        return code;
      };
      Blockly.Python['tank_motor'] = function (block) {
        const speed = block.getFieldValue('SPEED') || 0;
        const motors = (block.getFieldValue('MOTORS') || '').split(',').map(s => s.trim()).filter(Boolean);

        if (motors.length === 0) {
          return "# No motors selected\n";
        }

        let code = "";
        motors.forEach(motor => {
          code += `tank_motor("${motor}", ${speed})\n`;
        });

        return code;
      };

      Blockly.Python['sensor'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';
        const stateVal = block.getFieldValue('STATE') || '0';

        const ports = portsTxt
          .split(',')
          .map(s => s.trim())
          .filter(Boolean);

        if (!ports.length) {
          return "# do_onoff: no ports selected\n";
        }

        const fn = (stateVal === '1') ? 'sensor_on' : 'sensor_off';
        return ports.map(p => `${fn}(${p})\n`).join('');
      };

      Blockly.Python['tem_sensor'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';
        const stateVal = block.getFieldValue('STATE') || '0';

        const ports = portsTxt
          .split(',')
          .map(s => s.trim())
          .filter(Boolean);

        if (!ports.length) {
          return "# do_onoff: no ports selected\n";
        }

        const fn = (stateVal === '1') ? 'tem_sensor_on' : 'tem_sensor_off';
        return ports.map(p => `${fn}(${p})\n`).join('');
      };

      Blockly.Python['xray_sensor'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';
        const stateVal = block.getFieldValue('STATE') || '0';

        const ports = portsTxt
          .split(',')
          .map(s => s.trim())
          .filter(Boolean);

        if (!ports.length) {
          return "# do_onoff: no ports selected\n";
        }

        const fn = (stateVal === '1') ? 'xray_sensor_on' : 'xray_sensor_off';
        return ports.map(p => `${fn}(${p})\n`).join('');
      };
      Blockly.Python['rc_sensor'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';
        const stateVal = block.getFieldValue('STATE') || '0';

        const ports = portsTxt
          .split(',')
          .map(s => s.trim())
          .filter(Boolean);

        if (!ports.length) {
          return "# do_onoff: no ports selected\n";
        }

        const fn = (stateVal === '1') ? 'rc_sensor_on' : 'rc_sensor_off';
        return ports.map(p => `${fn}(${p})\n`).join('');
      };
      Blockly.Python['steper'] = function (block) {
        const speed = Number(block.getFieldValue('SPEED')) || 0;

        const motors = (block.getFieldValue('PORTS') || '')
          .split(',')
          .map(s => s.trim())
          .filter(Boolean);

        // ALWAYS return a STRING
        if (motors.length === 0) {
          return '# Stepper: no port selected\n';
        }

        if (motors.length === 1) {
          return `get_steper("${motors[0]}", ${speed})\n`;
        }

        const portList = motors.map(p => `"${p}"`).join(', ');
        return `get_steper(${portList}, ${speed})\n`;
      };
      Blockly.Python['waterpump'] = function (block) {
        const angle = block.getFieldValue('ANGLE') || 0;
        const ports = (block.getFieldValue('PORTS') || '').split(',').map(s => s.trim()).filter(Boolean);
        // ALWAYS return a STRING
        if (ports.length === 0) {
          return '# Waterpump: no port selected\n';
        }

        if (ports.length === 1) {
          return `get_waterpump("${ports[0]}", ${angle})\n`;
        }

        const portList = ports.map(p => `"${p}"`).join(', ');
        return `get_waterpump(${portList}, ${angle})\n`;
      };
      Blockly.Python['solinoid'] = function (block) {
        const angle = block.getFieldValue('STATE') || 0;
        const ports = (block.getFieldValue('PORTS') || '').split(',').map(s => s.trim()).filter(Boolean);
        // ALWAYS return a STRING
        if (ports.length === 0) {
          return '# Solinoid Valve: no port selected\n';
        }

        if (ports.length === 1) {
          return `get_solinoid("${ports[0]}", ${angle})\n`;
        }

        const portList = ports.map(p => `"${p}"`).join(', ');
        return `get_solinoid(${portList}, ${angle})\n`;
      };
      Blockly.Python['animo'] = function (block) {
        const angle = block.getFieldValue('STATE') || 0;
        const ports = (block.getFieldValue('PORTS') || '').split(',').map(s => s.trim()).filter(Boolean);
        // ALWAYS return a STRING
        if (ports.length === 0) {
          return '# Animo Meter: no port selected\n';
        }

        if (ports.length === 1) {
          return `get_animo("${ports[0]}", ${angle})\n`;
        }

        const portList = ports.map(p => `"${p}"`).join(', ');
        return `get_animo(${portList}, ${angle})\n`;
      };
      Blockly.Python['relay'] = function (block) {
        const angle = block.getFieldValue('STATE') || 0;
        const ports = (block.getFieldValue('PORTS') || '').split(',').map(s => s.trim()).filter(Boolean);
        // ALWAYS return a STRING
        if (ports.length === 0) {
          return '# relay: no port selected\n';
        }

        if (ports.length === 1) {
          return `get_relay("${ports[0]}", ${angle})\n`;
        }

        const portList = ports.map(p => `"${p}"`).join(', ');
        return `get_relay(${portList}, ${angle})\n`;
      };
      Blockly.Python['buzzer'] = function (block) {
        const val1 = block.getFieldValue('VAL1') || 0;
        const val2 = block.getFieldValue('VAL2') || 0;
        const val3 = block.getFieldValue('VAL3') || 0;
        const ports = (block.getFieldValue('PORTS') || '').split(',').map(s => s.trim()).filter(Boolean);
        // ALWAYS return a STRING
        if (ports.length === 0) {
          return '# Buzzer: no port selected\n';
        }

        if (ports.length === 1) {
          return `get_buzzer("${ports[0]}",${val1},${val2},${val3})\n`;
        }

        const portList = ports.map(p => `"${p}"`).join(', ');
        return `get_buzzer(${portList},${val1},${val2},${val3})\n`;
      };
      Blockly.Python['minifan'] = function (block) {
        const state = block.getFieldValue('STATE') || 0;
        const ports = (block.getFieldValue('PORTS') || '').split(',').map(s => s.trim()).filter(Boolean);
        // ALWAYS return a STRING
        if (ports.length === 0) {
          return '# MINI FAN: no port selected\n';
        }

        if (ports.length === 1) {
          return `get_fan("${ports[0]}",${state})\n`;
        }

        const portList = ports.map(p => `"${p}"`).join(',');
        return `get_fan(${portList},${state})\n`;
      };

      py['loop_end'] = b => `${b.getFieldValue('NAME') || ''}\n`;

      // Blockly.Python['rgb_display'] = function (block) {
      //   var red = block.getFieldValue('RED');
      //   var orange = block.getFieldValue('ORANGE');
      //   var yellow = block.getFieldValue('YELLOW');
      //   var green = block.getFieldValue('GREEN');
      //   var cyan = block.getFieldValue('CYAN');

      //   // Generate code that represents the action to display these colors
      //   var code = 'displayRGBColors(' + red + ',' + orange + ',' + yellow + ',' + green + ',' + cyan + ');\n';
      //   return code;
      // };
      // Blockly.Python['rgb_led_display'] = function (block) {
      //   var led = block.getFieldValue('LED');
      //   var color = block.getFieldValue('COLOR');
      //   var saturation = block.getFieldValue('SATURATION');
      //   var brightness = block.getFieldValue('BRIGHTNESS');
      //   var time = Blockly.Python.valueToCode(block, 'TIME', Blockly.Python.ORDER_ATOMIC);

      //   // Python code for controlling the LED
      //   var code = 'displayLED(' + led + ', ' + color + ', ' + saturation + ', ' + brightness + ', ' + time + ')\n';
      //   return code;
      // };
      Blockly.Python['rgb_component'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';
        const freq = block.getFieldValue('freq');
        const Delay1 = block.getFieldValue('Delay1');
        const DELAY2 = block.getFieldValue('DELAY2');

        const ports = portsTxt
          .split(',')
          .map(s => s.trim())
          .filter(Boolean);

        if (!ports.length) {
          return "# rgb_component: no ports selected\n";
        }

        let code = '';
        ports.forEach(port => {
          code += `rgb("${port}", ${freq}, ${Delay1}, ${DELAY2})\n`;
        });

        return code;
      };
      Blockly.Python['shock_sensor'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';

        // Split ports like "D3,H1"
        const pins = portsTxt
          .split(',')
          .map(p => p.trim())
          .filter(Boolean);

        // If no ports are selected, show a warning message
        if (!pins.length) {
          return ['# Invalid: Please select at least one port', Blockly.Python.ORDER_NONE];
        }

        // If one port is selected, return code for that port only
        if (pins.length === 1) {
          return [`shock_sensor("${pins[0]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If two ports are selected, use both for Trig and Echo
        if (pins.length === 2) {
          return [`shock_sensor("${pins[0]}","${pins[1]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If more than two ports are selected, return the first two only
        return [`shock_sensor("${pins[0]}","${pins[1]}","${pins[2]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
      };
      Blockly.Python['flex-sensor'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';

        // Split ports like "D3,H1"
        const pins = portsTxt
          .split(',')
          .map(p => p.trim())
          .filter(Boolean);

        // If no ports are selected, show a warning message
        if (!pins.length) {
          return ['# Invalid: Please select at least one port', Blockly.Python.ORDER_NONE];
        }

        // If one port is selected, return code for that port only
        if (pins.length === 1) {
          return [`flex("${pins[0]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If two ports are selected, use both for Trig and Echo
        if (pins.length === 2) {
          return [`flex("${pins[0]}","${pins[1]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If more than two ports are selected, return the first two only
        return [`flex("${pins[0]}","${pins[1]}","${pins[2]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
      };
      Blockly.Python['buzzer_component'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';
        const freq = block.getFieldValue('freq') || 1;
        const Delay1 = block.getFieldValue('Delay1') || 1000;
        const DELAY2 = block.getFieldValue('DELAY2') || 1000;

        const ports = portsTxt
          .split(',')
          .map(s => s.trim())
          .filter(Boolean);

        if (!ports.length) {
          return "# buzzer_component: no ports selected\n";
        }

        let code = '';
        ports.forEach(port => {
          code += `buzzer("${port}", ${freq}, ${Delay1}, ${DELAY2})\n`;
        });

        return code;
      };
      Blockly.Python['relay'] = function (block) {
        const angle = block.getFieldValue('STATE') || 0;
        const ports = (block.getFieldValue('PORTS') || '').split(',').map(s => s.trim()).filter(Boolean);
        // ALWAYS return a STRING
        if (ports.length === 0) {
          return '# Relay Valve: no port selected\n';
        }

        if (ports.length === 1) {
          return `relay("${ports[0]}", ${angle})\n`;
        }

        const portList = ports.map(p => `"${p}"`).join(', ');
        return `relay(${portList}, ${angle})\n`;
      };
      Blockly.Python['joystick_move'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';

        // Split ports like "D3,H1"
        const pins = portsTxt
          .split(',')
          .map(p => p.trim())
          .filter(Boolean);

        // If no ports are selected, show a warning message
        if (!pins.length) {
          return ['# Invalid: Please select at least one port', Blockly.Python.ORDER_NONE];
        }

        // If one port is selected, return code for that port only
        if (pins.length === 1) {
          return [`joy_stick("${pins[0]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If two ports are selected, use both for Trig and Echo
        if (pins.length === 2) {
          return [`joy_stick("${pins[0]}","${pins[1]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If more than two ports are selected, return the first two only
        return [`joy_stick("${pins[0]}","${pins[1]}","${pins[2]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
      };
      Blockly.Python['Air_quality_sensor'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';

        // Split ports like "D3,H1"
        const pins = portsTxt
          .split(',')
          .map(p => p.trim())
          .filter(Boolean);

        // If no ports are selected, show a warning message
        if (!pins.length) {
          return ['# Invalid: Please select at least one port', Blockly.Python.ORDER_NONE];
        }

        // If one port is selected, return code for that port only
        if (pins.length === 1) {
          return [`air_quality_sensor("${pins[0]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If two ports are selected, use both for Trig and Echo
        if (pins.length === 2) {
          return [`air_quality_sensor("${pins[0]}","${pins[1]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If more than two ports are selected, return the first two only
        return [`air_quality_sensor("${pins[0]}","${pins[1]}","${pins[2]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
      };
      Blockly.Python['flexi_force_sensor'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';

        // Split ports like "D3,H1"
        const pins = portsTxt
          .split(',')
          .map(p => p.trim())
          .filter(Boolean);

        // If no ports are selected, show a warning message
        if (!pins.length) {
          return ['# Invalid: Please select at least one port', Blockly.Python.ORDER_NONE];
        }

        // If one port is selected, return code for that port only
        if (pins.length === 1) {
          return [`flexi_sensor("${pins[0]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If two ports are selected, use both for Trig and Echo
        if (pins.length === 2) {
          return [`flexi_sensor("${pins[0]}","${pins[1]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If more than two ports are selected, return the first two only
        return [`flexi_sensor("${pins[0]}","${pins[1]}","${pins[2]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
      };
      Blockly.Python['TDS_Water_sensor'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';

        // Split ports like "D3,H1"
        const pins = portsTxt
          .split(',')
          .map(p => p.trim())
          .filter(Boolean);

        // If no ports are selected, show a warning message
        if (!pins.length) {
          return ['# Invalid: Please select at least one port', Blockly.Python.ORDER_NONE];
        }

        // If one port is selected, return code for that port only
        if (pins.length === 1) {
          return [`tds_sensor("${pins[0]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If two ports are selected, use both for Trig and Echo
        if (pins.length === 2) {
          return [`tds_sensor("${pins[0]}","${pins[1]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If more than two ports are selected, return the first two only
        return [`tds_sensor("${pins[0]}","${pins[1]}","${pins[2]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
      };
      Blockly.Python['LCD_print'] = function (block) {
        const txt = Blockly.Python.valueToCode(block, 'TEXT', Blockly.Python.ORDER_NONE) || "";
        // Example: send text to LCD
        return `lcd(${txt})\n`;
      };
      Blockly.Python['din_bo'] = function (block) {
        const port = block.getFieldValue('PORTS');
        return [`button("${port}")`, Blockly.Python.ORDER_NONE];
      };
      Blockly.Python['din_flame'] = function (block) {
        const port = block.getFieldValue('PORTS');
        return [`flame("${port}")`, Blockly.Python.ORDER_NONE];
      };
      Blockly.Python['din_temp'] = function (block) {
        const port = block.getFieldValue('PORTS');
        return [`temp("${port}")`, Blockly.Python.ORDER_NONE];
      };
      Blockly.Python['water_sensor'] = function (block) {
        const portsTxt = block.getFieldValue('PORTS') || '';

        // Split ports like "D3,H1"
        const pins = portsTxt
          .split(',')
          .map(p => p.trim())
          .filter(Boolean);

        // If no ports are selected, show a warning message
        if (!pins.length) {
          return ['# Invalid: Please select at least one port', Blockly.Python.ORDER_NONE];
        }

        // If one port is selected, return code for that port only
        if (pins.length === 1) {
          return [`water_sen("${pins[0]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If two ports are selected, use both for Trig and Echo
        if (pins.length === 2) {
          return [`water_sen("${pins[0]}","${pins[1]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
        }

        // If more than two ports are selected, return the first two only
        return [`water_sen("${pins[0]}","${pins[1]}","${pins[2]}")`, Blockly.Python.ORDER_FUNCTION_CALL];
      };
      Blockly.Python['any_input_block'] = function (block) {
        var value = block.getFieldValue('ANY');

        // Always return as string (prevents Python syntax errors)
        return [value, Blockly.Python.ORDER_ATOMIC];
      };

    }


    // POPUP AND PORT Selection FUNCTIONALITY
    /* --- modal wiring --- */

    // THIS IS FOR DIGITAL PINS
    let currentPortBlock = null;
    const ALL_PORT_NUMBERS = ["D3", "D4", "D5", "D6", "E3", "G4", "G5", "G6", "D7", "E0", "E1", "G3", "G0", "G1", "G2"];

    function openPortSelectionModal(block) {
      currentPortBlock = block;
      const txt = block.getFieldValue('PORTS') || '';
      const selectedSet = new Set(
        txt.split(',').map(s => s.trim()).filter(Boolean)
      );

      ALL_PORT_NUMBERS.forEach(p => {
        const cb = document.getElementById('port' + p);
        if (cb) cb.checked = selectedSet.has(String(p));
      });

      document.getElementById('portSelectionModal').style.display = 'block';
    }

    function closePortModal() {
      document.getElementById('portSelectionModal').style.display = 'none';
      currentPortBlock = null;
    }

    function savePortSelection() {
      if (!currentPortBlock) { closePortModal(); return; }

      const sel = [];
      ALL_PORT_NUMBERS.forEach(p => {
        const cb = document.getElementById('port' + p);
        if (cb && cb.checked) sel.push(String(p));
      });

      const label = sel.length ? sel.join(',') : '‚Äî';
      currentPortBlock.setFieldValue(label, 'PORTS');

      closePortModal();
    }

    //--------------------THIS IS FOR MOTOR PINS--------------
    let currentMotorBlock = null;

    function openMotorSelectionModal(block) {
      currentMotorBlock = block;
      const selectedMotors = new Set((block.getFieldValue('MOTORS') || '').split(',').map(s => s.trim()));

      ['E12', 'E11', 'C8', 'C9', 'B15', 'E13', 'E14', 'D15'].forEach(motor => {
        const checkbox = document.getElementById('motor' + motor);
        if (checkbox) checkbox.checked = selectedMotors.has(motor);
      });

      document.getElementById('motorSelectionModal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('motorSelectionModal').style.display = 'none';
    }

    function saveMotorSelection() {
      if (!currentMotorBlock) { closeModal(); return; }

      const selected = [];
      ['E12', 'E11', 'C8', 'C9', 'B15', 'E13', 'E14', 'D15'].forEach(motor => {
        const checkbox = document.getElementById('motor' + motor);
        if (checkbox && checkbox.checked) selected.push(motor);
      });

      const label = selected.length ? selected.join(',') : '‚Äî';
      currentMotorBlock.setFieldValue(label, 'MOTORS');

      closeModal();
    }

    /* ==== THIS FOR  SERVO MODAL PINS==== */
    let currentServoBlock = null;

    function openServoSelectionModal(block) {
      currentServoBlock = block;
      const currentPort = block.getFieldValue('SERVO_PORT') || '';

      const radios = document.querySelectorAll('#servoSelectionModal input[name="servoPort"]');
      radios.forEach(r => {
        r.checked = (r.value === currentPort);
      });

      document.getElementById('servoSelectionModal').style.display = 'block';
    }

    function closeServoModal() {
      document.getElementById('servoSelectionModal').style.display = 'none';
      currentServoBlock = null;
    }

    function saveServoSelection() {
      if (!currentServoBlock) { closeServoModal(); return; }

      const radios = document.querySelectorAll('#servoSelectionModal input[name="servoPort"]');
      let selectedValue = '';
      radios.forEach(r => {
        if (r.checked) selectedValue = r.value;
      });

      if (!selectedValue) {
        alert('Please select a servo port.');
        return;
      }

      currentServoBlock.setFieldValue(selectedValue, 'SERVO_PORT');
      closeServoModal();
    }
    /* ==== THIS IS FOR ANALOG PINS ==== */
    let currentLedBlock = null;
    const LED_PIN_NAMES = ['C0', 'C1', 'C2', 'F9', 'A3', 'F3', 'F4', 'F5', 'C4', 'C5', 'A1', 'A2', 'A4', 'F8', 'A6'];

    function openLedPinSelectionModal(block) {
      currentLedBlock = block;

      const txt = block.getFieldValue('PORTS') || '';   // üî¥ changed PINS ‚Üí PORTS
      const selected = new Set(
        txt.split(',').map(s => s.trim()).filter(Boolean)
      );

      LED_PIN_NAMES.forEach(pin => {
        const cb = document.getElementById('ledPin' + pin);
        if (cb) cb.checked = selected.has(pin);
      });

      document.getElementById('ledPinSelectionModal').style.display = 'block';
    }

    function closeLedPinModal() {
      document.getElementById('ledPinSelectionModal').style.display = 'none';
      currentLedBlock = null;
    }

    function saveLedPinSelection() {
      if (!currentLedBlock) {
        closeLedPinModal();
        return;
      }

      const sel = [];
      LED_PIN_NAMES.forEach(pin => {
        const cb = document.getElementById('ledPin' + pin);
        if (cb && cb.checked) sel.push(pin);
      });

      const label = sel.length ? sel.join(',') : '‚Äî';
      currentLedBlock.setFieldValue(label, 'PORTS');   // üî¥ changed PINS ‚Üí PORTS

      closeLedPinModal();
    }


    // -------------MAKE FUNCTION FOR ADD addGradient COLOR FOR BLOCK--------------------
    // ---- Add multiple gradient defs into Blockly SVG (from Code A) ----
    function addGradientDefs() {
      const svg = document.querySelector('svg.blocklySvg');

      if (!svg) {
        setTimeout(addGradientDefs, 50);
        return;
      }

      let defs = svg.querySelector('defs');
      if (!defs) {
        defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
        svg.prepend(defs);
      }

      function makeLinearGradient(id, stops) {
        const grad = document.createElementNS("http://www.w3.org/2000/svg", "linearGradient");
        grad.setAttribute('id', id);
        grad.setAttribute('x1', '0%');
        grad.setAttribute('y1', '0%');
        grad.setAttribute('x2', '0%');
        grad.setAttribute('y2', '100%');

        stops.forEach(s => {
          const stop = document.createElementNS("http://www.w3.org/2000/svg", "stop");
          stop.setAttribute('offset', s.offset);
          stop.setAttribute('stop-color', s.color);
          stop.setAttribute('stop-opacity', s.opacity);
          grad.appendChild(stop);
        });
        defs.appendChild(grad);
      }

      makeLinearGradient('gradDefault', [
        { offset: '0%', color: '#BBE8F2', opacity: 1 },
        { offset: '50%', color: '#2685BF', opacity: 1 },
        { offset: '100%', color: '#BBE8F2', opacity: 1 }
      ]);
      makeLinearGradient('gradled', [
        { offset: '0%', color: '#BF0413', opacity: 1 },
        { offset: '50%', color: '#BF0B2C', opacity: 1 },
        { offset: '100%', color: '#8C041D', opacity: 1 }
      ]);
      makeLinearGradient('dummy_style', [
        { offset: '0%', color: '#B2F252', opacity: 1 },
        { offset: '50%', color: '#79A637', opacity: 1 },
        { offset: '100%', color: '#EFF299', opacity: 1 }
      ]);

      makeLinearGradient('graddc', [
        { offset: '0%', color: '#F2A922' }, // #BBE8F2 with full opacity
        { offset: '50%', color: '#D97A07' }, // #2685BF with full opacity
        { offset: '100%', color: '#F2921D' } // #BBE8F2 with full opacity
      ]);
      makeLinearGradient('temp_style', [
        { offset: '0%', color: '#9F2CBF', opacity: 1 },
        { offset: '50%', color: '#73168C', opacity: 1 },
        { offset: '100%', color: '#9F2CBF', opacity: 1 }
      ]);

      makeLinearGradient('gradServo', [
        { offset: '0%', color: '#F2ACC6', opacity: 1 },
        { offset: '50%', color: '#F266C1', opacity: 1 },
        { offset: '100%', color: '#F2ACC6', opacity: 1 }
      ]);
      makeLinearGradient('ultra_style', [
        { offset: '0%', color: '#8C5946', opacity: 1 },
        { offset: '50%', color: '#593A28', opacity: 1 },
        { offset: '100%', color: '#D9B29C', opacity: 1 }
      ]);
      // Add filter for drop shadow effect
      function createDropShadowFilter(id, dx, dy, stdDeviation, color) {
        const filter = document.createElementNS("http://www.w3.org/2000/svg", "filter");
        filter.setAttribute('id', id);
        filter.setAttribute('x', '-50%');
        filter.setAttribute('y', '-50%');
        filter.setAttribute('width', '200%');
        filter.setAttribute('height', '200%');

        const feDropShadow = document.createElementNS("http://www.w3.org/2000/svg", "feDropShadow");
        feDropShadow.setAttribute('dx', dx);
        feDropShadow.setAttribute('dy', dy);
        feDropShadow.setAttribute('stdDeviation', stdDeviation);
        feDropShadow.setAttribute('flood-color', color);
        filter.appendChild(feDropShadow);

        defs.appendChild(filter);
      }

      // Create a Stroke Filter
      function createStrokeFilter(id, color, width) {
        const filter = document.createElementNS("http://www.w3.org/2000/svg", "filter");
        filter.setAttribute('id', id);
        filter.setAttribute('x', '-50%');
        filter.setAttribute('y', '-50%');
        filter.setAttribute('width', '200%');
        filter.setAttribute('height', '200%');

        const feStroke = document.createElementNS("http://www.w3.org/2000/svg", "feStroke");
        feStroke.setAttribute('color', color);
        feStroke.setAttribute('width', width);

        filter.appendChild(feStroke);



        defs.appendChild(filter);
      }

      // ------------add dropshadow here-------------
      // Create Drop Shadow Filters
      createDropShadowFilter('blueShadow', 2, 2, 5, '#2685BF');  // Drop shadow for 'start' block
      createDropShadowFilter('dcshodow', 2, 2, 5, '#D97A07');
      createDropShadowFilter('ledshodow', 2, 5, 5, '#D99CA7');
      createDropShadowFilter('servoshodow', 2, 2, 5, '#F279BC');
      createDropShadowFilter('dummyshadow', 2, 3, 5, '#79A637');// Drop shadow for 'dc_motor' block
      createDropShadowFilter('tempshadow', 2, 3, 5, '#593A28');
      createDropShadowFilter('ultrashowdow', 2, 2, 5, '#8B22A8');

    }

    function applyGradientAndShadowToBlock(block) {
      const blockPath = block.svgGroup_?.querySelector('.blocklyPath');

      if (!blockPath) return;

      // Apply gradient (example)
      blockPath.setAttribute('fill', 'url(#gradDefault)');

      // -------------declare shadow here ------------            
      // Apply combined shadow and stroke filter based on block type
      if (block.type === 'start') {
        blockPath.setAttribute('filter', 'url(#blueShadow)');  // Apply drop shadow
      }
      else if (block.type === 'port_on') {
        blockPath.setAttribute('filter', 'url(#ledshodow)');  // Apply drop shadow
      }
      else if (block.type === 'port_off') {
        blockPath.setAttribute('filter', 'url(#ledshodow)');  // Apply drop shadow
      }
      else if (block.type === 'sen_ultrasonic') {
        blockPath.setAttribute('filter', 'url(#ledshodow)');  // Apply drop shadow
      }
      else if (block.type === 'sen_temp') {
        blockPath.setAttribute('filter', 'url(#ledshodow)');  // Apply drop shadow
      }
      else if (block.type === 'do_onoff') {
        blockPath.setAttribute('filter', 'url(#servoshodow)')
      }
      else if (block.type === 'do_dc_motor') {
        blockPath.setAttribute('filter', 'url(#servoshodow)')
      }
      else if (block.type === 'do_servo') {
        blockPath.setAttribute('filter', 'url(#servoshodow)')
      }
      else if (block.type === 'bt_send') {
        blockPath.setAttribute('filter', 'url(#servoshodow)')
      }
      else if (block.type === 'do_led') {
        blockPath.setAttribute('filter', 'url(#servoshodow)')
      }
      else if (block.type == 'ctl_delay') {
        blockPath.setAttribute('filter', 'url(#dummyshadow)')
      }
      else if (block.type == 'do_led_param') {
        blockPath.setAttribute('filter', 'url(#dummyshadow)')
      }
      else if (block.type == 'lp_while') {
        blockPath.setAttribute('filter', 'url(#dcshodow)')
      }
      else if (block.type == 'lp_break') {
        blockPath.setAttribute('filter', 'url(#dcshodow)')
      }
      else if (block.type == 'lp_repeat_count') {
        blockPath.setAttribute('filter', 'url(#dcshodow)')
      }
      else if (block.type == 'lp_label') {
        blockPath.setAttribute('filter', 'url(#dcshodow)')
      }


      else if (block.type == 'sensor') {
        blockPath.setAttribute('filter', 'url(#tempshadow)')
      }
      else if (block.type == 'tem_sensor') {
        blockPath.setAttribute('filter', 'url(#tempshadow)')
      }
      else if (block.type == 'xray_sensor') {
        blockPath.setAttribute('filter', 'url(#tempshadow)')
      }
      else if (block.type == 'rc_sensor') {
        blockPath.setAttribute('filter', 'url(#tempshadow)')
      }
      else if (block.type === 'mini_motor') {
        blockPath.setAttribute('filter', 'url(#ultrashowdow)')
      }
      else if (block.type === 'remote_motor') {
        blockPath.setAttribute('filter', 'url(#ultrashowdow)')
      }
      else if (block.type === 'water_motor') {
        blockPath.setAttribute('filter', 'url(#ultrashowdow)')
      }
      else if (block.type === 'din_if_else') {
        blockPath.setAttribute('filter', 'url(#ultrashowdow)')
      }
      else if (block.type === 'din_sound') {
        blockPath.setAttribute('filter', 'url(#ultrashowdow)')
      }
      else if (block.type === 'tank_motor') {
        blockPath.setAttribute('filter', 'url(#ultrashowdow)')
      }

    }

    function setupGradientAndShadowOnBlocks() {
      Blockly.getMainWorkspace().addChangeListener((e) => {
        if (e.type === Blockly.Events.BLOCK_CREATE || e.type === Blockly.Events.BLOCK_CHANGE) {
          applyToAllBlocks();
        }
      });
    }

    // Apply gradient and shadow to all blocks in the workspace
    function applyToAllBlocks() {
      const blocks = Blockly.getMainWorkspace().getAllBlocks();
      blocks.forEach(block => {
        applyGradientAndShadowToBlock(block);  // Call the function to apply gradient, shadow, and stroke
      });
    }

    // Remove blue selection glow (from Code A)
    function killBlueSelection() {
      const style = document.createElement('style');
      style.textContent = `
        svg.blocklySvg .blocklySelected {
          filter: none !important;
        }
        svg.blocklySvg .blocklySelected > .blocklyPath {
          stroke: none !important;
          stroke-width: 0 !important;
        }
        svg.blocklySvg .blocklySelected > .blocklyPathLight {
          display: none !important;
        }
      `;
      document.head.appendChild(style);
    }





    // ADD USB BOOT FUNCTION IS HERE 

    // ===== Desktop: Web Serial USB to STM32 =====
    /* ============================================
       ==========  WEB SERIAL USB (FIXED) =========
       ============================================ */

    let stm32Port = null;
    let stm32Writer = null;
    let stm32Encoder = new TextEncoder();
    let stm32Reader = null;
    let stopUsbReader = false;


    /* ---- CONNECT TO STM32 ---- */
    async function connectStm32() {
      if (!("serial" in navigator)) {
        alert("Web Serial not supported. Use Chrome/Edge desktop.");
        return;
      }

      try {
        // Choose device
        stm32Port = await navigator.serial.requestPort();
        await stm32Port.open({ baudRate: 115200 });

        // If writer exists, unlock it
        if (stm32Port.writable.locked && stm32Writer) {
          try {
            stm32Writer.releaseLock();
          }
          catch (e) {
            console.log(e)
          }
        }


        // Create ONE writer
        stm32Writer = stm32Port.writable.getWriter();
        listenForData();
        alert("Connected to board!");
        console.log("STM32 connected.");
        handleBoardMessage("STM32 connected");
        setTimeout(function () {
          handleBoardMessage("-");
        }, 5000)

      } catch (e) {
        console.error("Failed to open port", e);
        alert("Connection failed");
      }


    }


    /* ==== WRITE user.py TO BOARD ==== */
    async function writeUserPyToBoard(code) {
      if (!stm32Port || !stm32Writer) {
        alert("Board not connected");
        return;
      }
      //-----------CODE SEND IS HERE---------------
      const payload = `@@START\n${code}\n@@END`;

      try {
        await stm32Writer.write(stm32Encoder.encode(payload));
        console.log("user.py sent to board");
      } catch (e) {
        console.error("USB write error:", e);
        alert("USB write failed");
      }
    }
    async function runUserPyOnBoard() {
      if (!stm32Port || !stm32Writer) {
        alert("Board not connected");
        return;
      }

      try {
        await stm32Writer.write(
          stm32Encoder.encode("RUN\n")
        );
        console.log("RUN command sent");
      } catch (e) {
        console.error("RUN failed:", e);
        alert("Failed to run program");
      }
    }

    /* ---- OPTIONAL: DISCONNECT SAFELY ---- */
    async function disconnectStm32() {
      try {
        stopUsbReader = true;

        // Optional: tell STM32
        if (stm32Writer) {
          await stm32Writer.write(
            stm32Encoder.encode("@@DISCONNECT@@\n")
          );
        }

        if (stm32Reader) {
          try { await stm32Reader.cancel(); } catch { }
        }

        if (stm32Writer) {
          stm32Writer.releaseLock();
        }

        if (stm32Port) {
          await stm32Port.close();
        }

        handleBoardMessage("USB disconnected");
        setTimeout(function () {
          handleBoardMessage("-");
        }, 5000)
      } catch (e) {
        console.error("Disconnect error:", e);
      } finally {
        stm32Port = null;
        stm32Writer = null;
        stm32Reader = null;
        stopUsbReader = false;
        console.log("STM32 fully disconnected");
      }
    }


    function handleBoardMessage(line) {
      console.log("Board:", line);

      // Optional: show in UI
      const el = document.getElementById("responseDisplay");
      if (el) {
        el.innerText = line;
      }
    }

    async function listenForData() {
      if (!stm32Port) return;

      const decoder = new TextDecoder();
      stm32Reader = stm32Port.readable.getReader();
      stopUsbReader = false;

      let buffer = "";

      try {
        while (!stopUsbReader) {
          const { value, done } = await stm32Reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });

          let lines = buffer.split("\n");
          buffer = lines.pop();

          for (let line of lines) {
            line = line.trim();
            if (!line) continue;
            handleBoardMessage(line);
          }
        }
      } catch (e) {
        if (!stopUsbReader) {
          console.error("USB read error:", e);
        }
      } finally {
        try {
          stm32Reader.releaseLock();
        } catch { }
        stm32Reader = null;
      }
    }





    //--------------WIFI BOOTING IS HERE---------------
    // ------------------wifi-----------
    async function sendCodeToESP32_MQTT(code) {
      const mqttClient = mqtt.connect('wss://3921b8461cb747b593a333f2aced8435.s1.eu.hivemq.cloud:8884/mqtt', {
        clientId: 'mqttjs_' + Math.random().toString(16).substr(2, 8),
        clean: true,
        connectTimeout: 10 * 1000,
        reconnectPeriod: 1000,
        protocolVersion: 5,
        username: 'ESP32',
        password: 'Esp@12345',
      });

      const topics = [
        'esp32/fire',
        'esp32/ultrasonic',
        'esp32/servo',
        'esp32/led',
        'esp32/motor',
        'esp32/message',  // This topic will update the Maths category
      ];

      // Connect to the MQTT broker
      mqttClient.on('connect', function () {
        console.log('Connected to HiveMQ broker');
        mqttClient.publish('esp32/boot', `@@START \n${code} \n @@END`);

        // Subscribe to the topics
        mqttClient.subscribe(topics, (err) => {
          if (err) {
            console.error('Topic subscribe failed:', err);
          } else {
            console.log('Subscribed to topics:', topics);
            handleBoardMessage("Wifi code sended sucessfully");

            setTimeout(function () {
              handleBoardMessage("-");
            }, 5000)
          }
        });
      });

      // Handle errors
      mqttClient.on('error', function (err) {
        console.error('MQTT connection error:', err);
        alert('Error: Unable to connect to MQTT broker. Please check your network or broker status.');
      });

      // Handle reconnections and resubscribe to the topic after reconnect
      mqttClient.on('reconnect', function () {
        console.log('Reconnecting to HiveMQ broker...');
        mqttClient.subscribe('esp32/message', function (err) {
          if (err) {
            console.error('Failed to subscribe after reconnect:', err);
          } else {
            console.log('Successfully re-subscribed to esp32/message topic');
          }
        });
      });

      // Handle connection closure
      mqttClient.on('close', function () {
        console.log('Connection to HiveMQ broker closed');
      });
      //WIFI RECEIVE MESSAGE FUNCTIONS
      // Receive messages from the topic you subscribe to
      mqttClient.on('message', function (topic, message) {
        const data = message.toString();
        console.log(`üì© ${topic}:`, data);

        switch (topic) {
          case 'esp32/fire':
            document.getElementById('fireStatus').innerText = data;
            break;

          case 'esp32/ultrasonic':
            document.getElementById('distance').innerText = data + ' cm';
            break;

          case 'esp32/servo':
            document.getElementById('servoAngle').innerText = data + '¬∞';
            break;

          case 'esp32/led':
            document.getElementById('ledStatus').innerText = data;
            break;

          case 'esp32/motor':
            document.getElementById('motorStatus').innerText = data;
            break;

          case 'esp32/message':
            // Update the Maths category (Temperature or any other string data)
            document.getElementById('temStatus').innerText = data + "¬∞C";
            break;

          default:
            console.warn('Unknown topic:', topic);
        }
      });

      // Handle connection closure (optional: clean-up after receiving data)
      mqttClient.on('close', function () {
        console.log('MQTT connection closed');
      });
    }



    //-------------BLUETHOOTH BOOTING IS HERE ---------------
    // ===============================
    // BLE (Web Bluetooth) - BOOTING
    // ===============================
    const BLE_SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
    const BLE_RX_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; // WRITE (Web -> ESP32)
    const BLE_TX_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // NOTIFY (ESP32 -> Web)
    // NEW: UUID specifically for WiFi (matches your backend)
    const BLE_WIFI_UUID = "6e400004-b5a3-f393-e0a9-e50e24dcca9e";


    let bleDevice = null;
    let bleServer = null;
    let bleService = null;
    let bleRxChar = null;
    let bleTxChar = null;

    function bleIsConnected() {
      return bleDevice && bleDevice.gatt && bleDevice.gatt.connected && bleRxChar;
    }

    async function connectBLEBoot() {
      if (!navigator.bluetooth) {
        alert("Web Bluetooth not supported. Use Chrome/Edge.");
        return false;
      }

      try {
        bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ services: [BLE_SERVICE_UUID] }]
        });

        bleDevice.addEventListener("gattserverdisconnected", () => {
          console.log("BLE disconnected");
          handleBoardMessage("BLE disconnected");
        });

        bleServer = await bleDevice.gatt.connect();
        bleService = await bleServer.getPrimaryService(BLE_SERVICE_UUID);

        bleRxChar = await bleService.getCharacteristic(BLE_RX_UUID);
        bleTxChar = await bleService.getCharacteristic(BLE_TX_UUID);

        // optional: notifications from ESP32 -> web
        await bleTxChar.startNotifications();
        bleTxChar.addEventListener("characteristicvaluechanged", (event) => {
          const decoder = new TextDecoder();
          const msg = decoder.decode(event.target.value);
          console.log("BLE notify:", msg);
          handleBoardMessage("BLE: " + msg);
        });

        handleBoardMessage("BLE connected ‚úÖ");
        return true;

        setTimeout(function () {
          handleBoardMessage("-");
        }, 5000)
      } catch (e) {
        console.error("BLE connect error:", e);
        alert("BLE connect failed: " + e);
        return false;
      }
    }

    async function bleWriteText(text) {
      const enc = new TextEncoder();
      await bleRxChar.writeValue(enc.encode(text));
    }

    // Send code in chunks (BLE limit)
    async function sendCodeToBLEBoot(code) {
      if (!code || !code.trim()) {
        alert("No code to send");
        return;
      }

      if (!bleIsConnected()) {
        const ok = await connectBLEBoot();
        if (!ok) return;
      }

      try {
        handleBoardMessage("BLE: sending...");

        const CHUNK = 150; // safe chunk size
        for (let i = 0; i < code.length; i += CHUNK) {
          const part = code.slice(i, i + CHUNK);
          await bleWriteText(`@@START\n${part}\n@@END`);
          await new Promise(r => setTimeout(r, 10)); // small delay
        }

        // optional: end marker (device should detect this)
        await bleWriteText("\n<<EOF>>\n");

        handleBoardMessage("BLE: sent ‚úÖ");
        setTimeout(function () {
          handleBoardMessage("-");
        }, 5000)
      } catch (e) {
        console.error("BLE send error:", e);
        alert("BLE send failed: " + e);
      }
    }

    // --- WiFi Modal Logic ---

    function openWifiModal() {
      document.getElementById('wifiSettingsModal').style.display = 'block';
    }

    function closeWifiModal() {
      document.getElementById('wifiSettingsModal').style.display = 'none';
    }

    // 1. Get values, 2. Close Modal, 3. Send via Bluetooth
    async function saveWifiSettings() {
      const ssid = document.getElementById('wifiSSID').value;
      const pass = document.getElementById('wifiPass').value;

      if (!ssid) {
        alert("Please enter an SSID");
        return;
      }

      closeWifiModal();

      // Call the Bluetooth function
      await sendWifiConfigOverBLE(ssid, pass);
    }

    // Function to send WiFi Credentials via BLE
    async function sendWifiConfigOverBLE(ssid, password) {
      if (!navigator.bluetooth) {
        alert("Web Bluetooth not supported.");
        return;
      }

      // Format: "ssid,password"
      const payload = `${ssid},${password}`;
      const encoder = new TextEncoder();

      try {
        // 1. Request Device
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [BLE_SERVICE_UUID] }]
        });

        // 2. Connect
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(BLE_SERVICE_UUID);

        // 3. Get the WiFi Characteristic
        const wifiChar = await service.getCharacteristic(BLE_WIFI_UUID);

        // 4. Write Data
        await wifiChar.writeValue(encoder.encode(payload));

        alert("WiFi Credentials sent to board! ‚úÖ");

      } catch (error) {
        console.error("BLE WiFi Error:", error);
        alert("Failed to send: " + error);
      }
    }



    // ABOVE ALL FUNCTION AND BLOCK WORKSPACE DECLAREATION IS HERE
    /* --- app start --- */
    async function start() {




      // Connect Board button (desktop Web Serial)
      document.getElementById("btnConnect").onclick = () => {
        connectStm32();
      };

      document.getElementById("btnDisconnect").onclick = async () => {
        if (!stm32Port) {
          alert("No board connected");
          return;
        }
        await disconnectStm32();
        alert("board Disconnected Sucessfully")
      };




      const ok = await waitForBlockly();
      if (!ok) { console.error('Blockly/Python failed to load'); return; }

      // Theme from Code A (glass style)
      const Theme = Blockly.Theme.defineTheme('rndmfg_glass', {
        base: Blockly.Themes.Classic,
        componentStyles: {
          workspaceBackgroundColour: '#ffffff',
          toolboxBackgroundColour: 'rgba(15,23,42,0.7)',
          toolboxForegroundColour: '#e5e7eb',
          flyoutBackgroundColour: 'rgba(15,23,42,0.95)',
          flyoutForegroundColour: '#e5e7eb',
          flyoutOpacity: 1,
          insertionMarkerColour: '#38bdf8',
          insertionMarkerOpacity: 0.0,
          scrollbarColour: '#94a3b8',
          selectedGlowColour: 'transparent',
          selectedGlowOpacity: 0,
          selectedGlowSize: 1,
          cursorColour: '#facc15'
        }
      });

      defineBlocks();
      defineGenerators();

      workspace = Blockly.inject('blocklyDiv', {
        toolbox: document.getElementById('toolbox'),
        theme: Theme,
        renderer: 'zelos',
        grid: { spacing: 30, length: 7, colour: '#b7b7b7', snap: true },
        trashcan: true,
        zoom: { controls: true, wheel: true, startScale: 0.9, maxScale: 2.0, minScale: 0.4 },
        move: { scrollbars: true, drag: true, wheel: true },
        sound: true
      });






      //ABOVE FUNCTION CALL IS HERE
      // Apply design enhancements (gradients + selection fix)
      addGradientDefs();
      killBlueSelection();
      setupGradientAndShadowOnBlocks();


      // HERE WE ADD  COSTOM SOUND 
      // Custom sound logic from Code A
      const audio = workspace.getAudioManager();
      audio.SOUNDS_ = {};

      audio.load(["./assets/blockly/sounds/block_merge.mpeg"], "click");
      audio.load(["./assets/blockly/sounds/cancel.mp3"], "delete");
      audio.load(["./assets/blockly/sounds/block_merge.mpeg"], "dragstart");
      audio.load(["./assets/blockly/sounds/block_merge.mpeg"], "dragend");
      audio.load(["./assets/blockly/sounds/error.mp3"], "error");
      audio.load(["./assets/blockly/sounds/disconnect.mp3"], "disconnect");

      // DRAG START
      // workspace.addChangeListener((ev) => {
      //   if (ev.type === Blockly.Events.BLOCK_DRAG && ev.isStart) {
      //     audio.play("dragstart");
      //   }
      // });

      // DRAG END
      // workspace.addChangeListener((ev) => {
      //   if (ev.type === Blockly.Events.BLOCK_DRAG && ev.isEnd) {
      //     audio.play("dragend");
      //   }
      // });

      // BLOCK SNAP / MOVE
      workspace.addChangeListener((ev) => {
        if (ev.type === Blockly.Events.BLOCK_MOVE && ev.isStart) {
          audio.play("click");
        }
      });

      // BLOCK DELETE
      workspace.addChangeListener((ev) => {
        if (ev.type === Blockly.Events.BLOCK_DELETE) {
          audio.play("delete");
        }
      });

      // INVALID CONNECTION (error sound)
      Blockly.Connection.prototype.highlightForError = function () {
        audio.play("error");
      };

      // Python output
      const pyOut = document.getElementById('pyOut');

      // runs whenever blocks change ‚Äì just for on-screen preview
      function updateCode() {
        const code = Blockly.Python.workspaceToCode(workspace);
        pyOut.textContent = code || '# (no blocks yet)';

        // Optional live preview message (not used for upload)
        try {
          window.ReactNativeWebView?.postMessage(
            JSON.stringify({ type: 'py_preview', code })
          );
        } catch (e) { }
      }

      workspace.addChangeListener(updateCode);
      updateCode();


      // HERE IS ADD ALL BTN LOGIC

      // wifi logic
      document.getElementById("btnWifi").onclick = async () => {
        if (!workspace) {
          alert("Blockly not ready yet");
          return;
        }

        const code = Blockly.Python.workspaceToCode(workspace);

        if (!code.trim()) {
          alert("No code to send");
          return;
        }

        // Send code via MQTT
        await sendCodeToESP32_MQTT(code);
      };

      // Bluetooth boot button
      document.getElementById("btnBluetooth").onclick = async () => {
        if (!workspace) {
          alert("Blockly not ready yet");
          return;
        }

        const code = Blockly.Python.workspaceToCode(workspace);

        if (!code.trim()) {
          alert("No code to send");
          return;
        }

        await sendCodeToBLEBoot(code);
      };


      // WiFi Config Button Listener
      document.getElementById("btnWifiConfig").onclick = openWifiModal;




      // ========== RUN / UPLOAD BUTTON ==========
      document.getElementById('btnRun').onclick = async () => {

        // Desktop + USB connected ‚Üí RUN user.py
        if (stm32Port && stm32Writer) {
          await runUserPyOnBoard();
          return;
        }

        // Mobile WebView
        if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
          const code = Blockly.Python.workspaceToCode(workspace);
          window.ReactNativeWebView.postMessage(
            JSON.stringify({
              type: "python_upload",
              code: code,
              entry_function: "main",
            })
          );
          alert("Code sent to mobile app");
          return;
        }

        alert("No board connected");
      };
      document.getElementById('btnSave').onclick = async () => {
        const code = Blockly.Python.workspaceToCode(workspace);

        if (!code.trim()) {
          alert("No code to save");
          return;
        }
        // fallback ‚Üí XML download
        const xml = Blockly.Xml.domToPrettyText(
          Blockly.Xml.workspaceToDom(workspace)
        );
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([xml], { type: 'text/xml' }));
        a.download = 'program.xml';
        a.click();
        URL.revokeObjectURL(a.href);
      };


      document.getElementById('btnboot').onclick = async () => {
        const code = Blockly.Python.workspaceToCode(workspace);

        // USB connected ‚Üí write user.py
        if (stm32Port && stm32Writer) {
          await writeUserPyToBoard(code);
          document.getElementById("responseDisplay").innerText = "user.py saved on board";
          return;
        }
      }

      document.getElementById('btnLoad').onclick = async () => {
        const [f] = await (window.showOpenFilePicker
          ? await showOpenFilePicker({
            types: [{ description: 'XML', accept: { 'text/xml': ['.xml'] } }]
          }).catch(() => [])
          : []);
        let text = '';
        if (f) {
          text = await (await f.getFile()).text();
        } else {
          const inp = document.createElement('input');
          inp.type = 'file';
          inp.accept = '.xml,text/xml';
          inp.onchange = async e => {
            const file = e.target.files[0];
            const t = await file.text();
            loadXml(t);
          };
          inp.click();
          return;
        }
        loadXml(text);
      };

      function loadXml(text) {
        if (!text) return;
        workspace.clear();
        Blockly.Xml.domToWorkspace(Blockly.utils.xml.textToDom(text), workspace);
      }

      document.getElementById('btnClear').onclick = () => {
        workspace.clear();
        updateCode();
      };


      //   -----------show output code----------------
      const showCode = document.getElementById("showCode");
      const code = document.querySelector(".code");
      const show = document.querySelector(".show");
      const main = document.querySelector(".main")
      const main1 = document.querySelector(".main1")

      showCode.addEventListener("click", function () {
        code.classList.toggle("show");
        main.classList.toggle("main1");
        // üî• VERY IMPORTANT for Blockly
        setTimeout(() => {
          Blockly.svgResize(workspace);
          workspace.scrollCenter();
        }, 50);
      })


      // function toggleCodePanel() {
      //   const code = document.getElementById("codePanel");
      //   const main = document.querySelector(".main");

      //   const isHidden = code.classList.toggle("hidden");

      //   if (isHidden) {
      //     main.classList.add("expand");
      //   } else {
      //     main.classList.remove("expand");
      //   }

      // }


      const demo = `
<xml xmlns="https://developers.google.com/blockly/xml">
  <block type="start" x="40" y="40">
    <field name="NAME">when Start Button clicked</field>
  </block>
</xml>`;
      Blockly.Xml.domToWorkspace(Blockly.utils.xml.textToDom(demo), workspace);
    }

    window.addEventListener('load', start);
  </script>
</body>

</html>